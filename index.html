<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Malzeme Stok Durumu</title>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'custom-blue': '#2563eb',
            'custom-darkblue': '#1e40af',
            'status-warning': '#fff8dc', // Mevcut uyarı rengi
            'status-danger': '#f8d7da',  // Mevcut kritik renk
            'zebra-strip': '#f3f4f6',    // Zebra Şerit rengi
          }
        }
      }
    }
  </script>

  <style>
    /* Chart.js'in boyutunu kontrol etmek için temel stil */
    #chartContainer {
      height: 300px; /* Grafik alanının yüksekliğini belirle */
      width: 100%;
    }
    /* Tablo genişliklerini ve kaydırma çubuğunu yönetmek için */
    .table-responsive {
        overflow-x: auto;
    }
    
    /* Gerekli olan özel CSS: Satır renklendirme sınıfları */
    /* !important ile Zebra şerit kuralını ezer */
    .status-success { background-color: transparent; } 
    .status-warning { background-color: #fff8dc !important; } 
    .status-danger { background-color: #f8d7da !important; }  
    
    /* Özel Zebra Şerit kuralı (tek numaralı satırlara) */
    tbody tr:nth-child(odd) {
        background-color: #f3f4f6; 
    }
    
    /* YAZDIRMA (PDF) AYARLARI */
    @media print {
        /* Kontrol, açıklama ve sayfalama ögelerini gizle */
        .controls, .legend, .pagination { 
            display: none !important;
        }
        h1 { margin-top: 0; }
        #tableContainer { box-shadow: none; padding: 0; }
        /* Tablo çizgilerini açık mavi yap */
        table, th, td { border-color: #60a5fa !important; } 
    }
    
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body class="font-sans bg-gray-100 text-gray-800 p-5">
  <h1 class="text-3xl font-bold text-center mb-1">📊 ABONE İŞLERİ DAİRESİ BAŞKANLIKLARI AMBAR STOK DURUMU</h1>
  
  <input type="text" id="reportInfo" 
         placeholder="Rapor tarihini, versiyonunu veya ek notları buraya girin..." 
         class="block w-3/4 mx-auto text-center border-b border-gray-400 focus:outline-none focus:border-custom-blue p-1 mb-6 
                text-lg font-bold text-gray-900 bg-transparent"
         value="">
  
  <div class="flex flex-wrap justify-center items-center gap-4 mb-6 p-4 bg-white rounded-lg shadow-md controls">
    <input type="file" id="csvFile" accept=".csv" class="p-2 border border-gray-300 rounded-lg">
    <button onclick="loadCSV()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Yükle</button>
    
    <div class="flex gap-2">
      <input type="text" id="searchInput" placeholder="Malzeme adına göre ara..." onkeyup="applyFilters()" class="p-2 border border-gray-300 rounded-lg">
      <button onclick="clearSearch()" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Temizle</button>
    </div>
    
    <select id="filterSelect" onchange="applyFilters()" class="p-2 border border-gray-300 rounded-lg">
      <option value="hepsi">Tüm Durumlar</option>
      <option value="success">Stok Yeterli</option>
      <option value="warning">Stok Azalıyor</option>
      <option value="danger">Kritik Seviye</option>
    </select>
    
    <select id="rowsPerPage" onchange="applyFilters()" class="p-2 border border-gray-300 rounded-lg">
      <option value="5">5 Satır / Sayfa</option>
      <option value="10">10 Satır / Sayfa</option>
      <option value="20">20 Satır / Sayfa</option>
      <option value="50">50 Satır / Sayfa</option>
      <option value="0" selected>Tümü</option>
    </select>
    
    <button onclick="exportPDF()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">PDF Olarak Dışa Aktar</button>
  </div>

  <div id="chartContainer" class="bg-white p-4 rounded-lg shadow-md mb-6 w-3/4 mx-auto">
    <canvas id="chart"></canvas>
  </div>

  <div class="text-center mb-4 legend flex justify-center gap-4">
    <button onclick="setFilterAndApply('success')" 
            class="py-1 px-3 rounded-lg bg-gray-100 hover:bg-gray-200 border border-gray-300 hover:shadow-md transition duration-150">Stok Yeterli (> 8 Ay)</button>

    <button onclick="setFilterAndApply('warning')" 
            class="py-1 px-3 rounded-lg bg-status-warning hover:bg-yellow-200 border border-gray-300 hover:shadow-md transition duration-150">Stok Azalıyor (6 - 8 Ay)</button>

    <button onclick="setFilterAndApply('danger')" 
            class="py-1 px-3 rounded-lg bg-status-danger hover:bg-red-200 border border-gray-300 hover:shadow-md transition duration-150">Kritik Seviye (< 6 Ay)</button>
            
    <button onclick="setFilterAndApply('hepsi')" 
            class="py-1 px-3 rounded-lg bg-blue-100 hover:bg-blue-200 border border-blue-200 hover:shadow-md transition duration-150">Tüm Durumlar</button>
  </div>

  <div id="tableContainer" class="bg-white p-4 rounded-lg shadow-md table-responsive"></div>
  
  <div class="text-center mt-4 pagination" id="pagination"></div>

  <script>
    let allRows = [];
    let chartInstance = null;
    let currentSort = { column: null, asc: true };
    let currentPage = 1;

    function loadCSV() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      if (!file) { alert('Lütfen bir CSV dosyası seçin.'); return; }
      const reader = new FileReader();
      reader.onload = e => parseCSV(e.target.result);
      reader.readAsText(file, 'UTF-8');
    }

    function parseCSV(csvText) {
      csvText = csvText.replace(/\uFEFF/g, '').trim();
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      allRows = parsed.data.map(r => {
        const yillik = parseFloat((r['Yıllık Tüketim']||'0').replace(',','.'));
        const stok = parseFloat((r['Mevcut Stok']||'0').replace(',','.'));
        const ihale = parseFloat((r['İhale Miktarı']||'0').replace(',','.'));
        const aylik = yillik/12;
        return {
          'Malzeme Adı': (r['Malzeme Adı']||'').trim(),
          'Mevcut Stok': stok,
          'Yıllık Tüketim': yillik,
          'İhale Miktarı': ihale,
          'Stok Kaç Ay Yeter': aylik? stok/aylik:0,
          'Stok İhale Sonrası Kaç Ay Yeter': aylik? (stok+ihale)/aylik:0,
          'Açıklama': (r['Açıklama']||'').trim()
        };
      }).filter(r=>r['Malzeme Adı']);

      currentPage = 1;
      applyFilters();
    }
    
    function clearSearch() {
        document.getElementById('searchInput').value = ''; 
        applyFilters(); 
    }
    
    // YENİ FONKSİYON
    function setFilterAndApply(filterValue) {
      document.getElementById('filterSelect').value = filterValue;
      applyFilters();
    }

    function renderTable(rows) {
      const container = document.getElementById('tableContainer');
      if (!rows.length){
        container.innerHTML = '<p class="text-center text-gray-500">Henüz veri yok.</p>';
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      let rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
      if (rowsPerPage === 0) rowsPerPage = rows.length; 

      const totalPages = Math.ceil(rows.length / rowsPerPage);
      if(currentPage > totalPages) currentPage = totalPages; 
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageRows = rows.slice(start, end);

      // Tablo HTML oluşturma - Çizgiler açık mavi, Başlıklar kalın
      let html = `<table class="min-w-full divide-y divide-blue-400 border border-blue-400">
        <thead>
          <tr>
            <th class="px-6 py-3 bg-custom-blue text-left text-sm font-bold text-white uppercase tracking-wider cursor-pointer border-r border-blue-400" onclick="sortTable('Malzeme Adı')">Malzeme Adı ↕</th>
            <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer border-r border-blue-400" onclick="sortTable('Mevcut Stok')">Mevcut Stok ↕</th>
            <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer border-r border-blue-400" onclick="sortTable('Yıllık Tüketim')">Yıllık Tüketim ↕</th>
            <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer border-r border-blue-400" onclick="sortTable('İhale Miktarı')">İhale Miktarı ↕</th>
            <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer border-r border-blue-400" onclick="sortTable('Stok Kaç Ay Yeter')">Stok Kaç Ay Yeter ↕</th>
            <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer border-r border-blue-400" onclick="sortTable('Stok İhale Sonrası Kaç Ay Yeter')">Stok İhale Sonrası Kaç Ay Yeter ↕</th>
            <th class="px-6 py-3 bg-custom-blue text-left text-sm font-bold text-white uppercase tracking-wider cursor-pointer" onclick="sortTable('Açıklama')">Açıklama ↕</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-blue-400">`;

      pageRows.forEach(r => {
        let cls = 'status-success';
        // Renklendirme kuralı: İhale sonrası yeterlilik
        const ay = r['Stok İhale Sonrası Kaç Ay Yeter']; 
        if (ay < 6) cls = 'status-danger';
        else if(ay < 8) cls = 'status-warning';

        // border-b ve border-r çizgileri açık mavi
        html += `<tr class="${cls} border-b border-blue-400">
          <td class="px-6 py-4 whitespace-normal text-sm text-gray-900 border-r border-blue-400">${r['Malzeme Adı']}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center border-r border-blue-400">${r['Mevcut Stok'].toLocaleString('tr-TR')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center border-r border-blue-400">${r['Yıllık Tüketim'].toLocaleString('tr-TR')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center border-r border-blue-400">${r['İhale Miktarı'].toLocaleString('tr-TR')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center border-r border-blue-400">${r['Stok Kaç Ay Yeter'].toFixed(1).replace('.',',')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center border-r border-blue-400">${r['Stok İhale Sonrası Kaç Ay Yeter'].toFixed(1).replace('.',',')}</td>
          <td class="px-6 py-4 whitespace-normal text-sm text-gray-900 text-left">${r['Açıklama']}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;

      // Sayfalama butonları
      const paginationDiv = document.getElementById('pagination');
      if (parseInt(document.getElementById('rowsPerPage').value) === 0) {
        paginationDiv.innerHTML = '';
        return;
      }
      
      let paginationHtml = '';

      // Tailwind sınıflarıyla Sayfalama butonları
      const btnBase = 'py-1 px-3 mx-1 rounded-md text-white transition duration-150';
      const btnActive = 'bg-custom-darkblue font-bold';
      const btnInactive = 'bg-custom-blue hover:bg-custom-darkblue';
      const btnDisabled = 'bg-gray-400 cursor-not-allowed';

      const firstBtnClass = currentPage === 1 ? btnDisabled : btnInactive;
      const prevBtnClass = currentPage === 1 ? btnDisabled : btnInactive;
      const lastBtnClass = currentPage === totalPages ? btnDisabled : btnInactive;
      const nextBtnClass = currentPage === totalPages ? btnDisabled : btnInactive;

      paginationHtml += `<button onclick="goPage(1)" class="${btnBase} ${firstBtnClass}" ${currentPage === 1 ? 'disabled' : ''}>İlk</button>`;
      paginationHtml += `<button onclick="goPage(${currentPage - 1})" class="${btnBase} ${prevBtnClass}" ${currentPage === 1 ? 'disabled' : ''}>Önceki</button>`;

      for (let i = 1; i <= totalPages; i++) {
        const pageClass = i === currentPage ? btnActive : btnInactive;
        paginationHtml += `<button onclick="goPage(${i})" class="${btnBase} ${pageClass}">${i}</button>`;
      }

      paginationHtml += `<button onclick="goPage(${currentPage + 1})" class="${btnBase} ${nextBtnClass}" ${currentPage === totalPages ? 'disabled' : ''}>Sonraki</button>`;
      paginationHtml += `<button onclick="goPage(${totalPages})" class="${btnBase} ${lastBtnClass}" ${currentPage === totalPages ? 'disabled' : ''}>Son</button>`;

      paginationDiv.innerHTML = '<div class="pagination flex justify-center">' + paginationHtml + '</div>';
    }


    function goPage(page){ 
      currentPage=page; 
      applyFilters(); 
    }

    function renderChart(rows){
      const ctx=document.getElementById('chart').getContext('2d');
      const critical = rows.sort((a,b)=>a['Stok Kaç Ay Yeter']-b['Stok Kaç Ay Yeter']).slice(0,5);
      const labels = critical.map(r=>r['Malzeme Adı']);
      const values = critical.map(r=>r['Stok Kaç Ay Yeter']*30); // gün olarak
      if(chartInstance) chartInstance.destroy();
      
      chartInstance = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{label:'Kalan Stok (Gün)', data:values, backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']}]},
        options:{
          indexAxis:'y', 
          responsive:true,               
          maintainAspectRatio: false,     
          
          layout: {
            padding: {
              left: 100, // Sol boşluk (etiketler için)
              right: 120 // Sağ boşluk (Taşmayı önler)
            }
          },
          
          plugins:{
            legend:{display:false},
            
            // Başlık (Title)
            title: {
              display: true,
              text: 'Kritik Seviyedeki İlk 5 Malzeme Stok Yeterliliği', 
              font: {
                size: 16,
                weight: 'bold'
              },
              color: '#333333' 
            },
            
            datalabels:{ anchor:'end', align:'right', formatter: value=>Math.round(value)+' gün' }
          },
          scales:{x:{beginAtZero:true}}
        },
        plugins: [ChartDataLabels]
      });
    }

    function sortTable(col){
      const asc = currentSort.column===col?!currentSort.asc:true;
      currentSort={column:col,asc};
      allRows.sort((a,b)=>{
        const valA=a[col]||0,valB=b[col]||0;
        return typeof valA==='string'? (asc? valA.localeCompare(valB): valB.localeCompare(valA)) : (asc? valA-valB: valB-valA);
      });
      applyFilters();
    }

    function applyFilters(){
      const search=document.getElementById('searchInput').value.toLowerCase();
      // Filtre değeri artık hem SELECT kutusundan hem de butonlardan gelebilir
      const filter=document.getElementById('filterSelect').value;
      
      let filtered=allRows.filter(r=>r['Malzeme Adı'].toLowerCase().includes(search));
      
      if(filter!=='hepsi'){
        filtered=filtered.filter(r=>{
          // Filtreleme: İhale Sonrası Yeterlilik sütununa göre yapıldı
          const ay=r['Stok İhale Sonrası Kaç Ay Yeter']; 
          if(filter==='success') return ay>=8;
          if(filter==='warning') return ay>=6 && ay<8;
          if(filter==='danger') return ay<6;
        });
      }
      
      renderTable(filtered);
      renderChart(filtered);
    }

    function exportPDF(){ window.print(); }
  </script>
</body>
</html>

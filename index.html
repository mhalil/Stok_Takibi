<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Malzeme Stok Durumu ve Maliyet Analizi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v3.x.x/dist/cdn.min.js" defer></script>


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#2563eb',
                        'custom-darkblue': '#1e40af',
                        'status-warning': '#fff8dc', 
                        'status-danger': '#f8d7da',  
                        'zebra-strip': '#f3f4f6',    
                    }
                }
            }
        }
    </script>

    <style>
        /* Grafik taÅŸÄ±yÄ±cÄ±larÄ±na sabit yÃ¼kseklik verilir */
            #chartCurrentContainer, #chartAfterTenderContainer {
                height: 250px; /* Bu deÄŸeri 350px'ten 250px'e dÃ¼ÅŸÃ¼rdÃ¼k */
            }
            #chartCurrentCostContainer, #chartTenderCostContainer {
                height: 350px;  /* Bu kÄ±sÄ±m aynÄ± kalabilir veya sizin isteÄŸinize gÃ¶re deÄŸiÅŸebilir */
            }

        /* Tablo geniÅŸliklerini ve kaydÄ±rma Ã§ubuÄŸunu yÃ¶netmek iÃ§in */
        .table-responsive {
            overflow-x: auto;
        }
        
        /* Tablo stil */
        #tableContainer table {
            border-collapse: separate;
            border-spacing: 0 0.4rem; /* Dikey boÅŸluk */
        }
        
        /* Renklendirme kurallarÄ± */
        tbody tr:nth-child(odd) {
            background-color: #f3f4f6 !important;  
        }
        #tableContainer tr.status-warning { background-color: #fff8dc !important; }  
        #tableContainer tr.status-danger { background-color: #f8d7da !important; }  
        
        /* YazdÄ±rma ayarlarÄ± */
        @media print {
            .mb-6 { margin-bottom: 0 !important; }  
            #chartsContainer, #chartsContainer2 { padding: 0 !important; }
            
            /* Kontrol ve Filtreleme BileÅŸenlerini Gizle */
            .controls, 
            .legend, 
            #settingsCanvas, 
            .ts-control, 
            .chart-toggle-button, 
            .summary-toggle-button,
            #legendContainer,
            #rangeFilterCanvas { 
                display: none !important; 
            }
            
            h1 { margin-top: 0; }
            #tableContainer { box-shadow: none; padding: 0; }
            
            /* GizlenmiÅŸ grafik/Ã¶zet kaplarÄ±nÄ± yazdÄ±rma anÄ±nda da gizler */
            .hidden-for-print {
                display: none !important;
            }

        }

        /* SÃ¼tun ve Kategori AyarlarÄ± MenÃ¼sÃ¼ Ä°Ã§in Ã–zel CSS */
        .dropdown-menu {
            z-index: 10;
        }

        /* Tom Select iÃ§in Ã¶zel stil ayarlamalarÄ± (Tailwind'e uyum) */
        .ts-control {
            @apply p-2 border border-gray-300 rounded-lg shadow-sm w-full md:min-w-[300px] bg-white;
        }
        .ts-wrapper.multi .ts-control > div {
            @apply bg-custom-blue text-white rounded-md text-sm py-1 px-2;
        }
        
        /* LEGEND/FÄ°LTRE BÃ–LÃœMÃœ YENÄ° STÄ°LÄ° */
        #legendContainer {
            @apply flex flex-wrap justify-center items-center gap-4 p-4 bg-white rounded-2xl shadow-md;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body class="font-sans bg-gray-100 p-5">
    <h1 class="text-3xl font-bold text-center mb-1 text-gray-800">ğŸ“Š AMBAR STOK DURUMU VE MALÄ°YET ANALÄ°ZÄ° ğŸ— </h1>
    
    <input type="text" id="reportInfo" 
            placeholder="Rapor tarihini, versiyonunu veya ek notlarÄ± buraya girin..." 
            class="block w-3/4 mx-auto text-center border-b border-gray-400 focus:outline-none focus:border-custom-blue p-1 mb-6 
                         text-lg font-bold text-gray-900 bg-transparent"
            value="">
    
    <div class="flex flex-wrap justify-center items-center gap-4 mb-6 p-4 bg-white rounded-2xl shadow-md controls">
        <input type="file" id="csvFile" accept=".csv" class="p-2 border border-gray-300 rounded-lg">
        <button onclick="loadCSV()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">YÃ¼kle</button>
        
        <button onclick="exportPDF()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">PDF Olarak DÄ±ÅŸa Aktar</button>
    </div>
    <div class="mb-6 border-b border-gray-300">
        <div onclick="toggleChartSection('chartsContainer')" class="flex items-center justify-between p-2 bg-gray-200 hover:bg-gray-300 cursor-pointer rounded-t-2xl chart-toggle-button">
            <h3 class="text-xl font-bold text-gray-800">ğŸ“ˆ Stok YeterliliÄŸi Grafikleri (Ay BazlÄ±)</h3>
            <svg id="chartsContainerArrow" class="w-6 h-6 text-gray-600 transition-transform duration-300 transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
        
        <div id="chartsContainer" class="flex gap-4 p-4 bg-white rounded-b-2xl transition-all duration-300">
            <div id="chartCurrentContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartCurrent"></canvas>
            </div>
            <div id="chartAfterTenderContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartAfterTender"></canvas>
            </div>
        </div>
    </div>

    <div class="mb-6 border-b border-gray-300">
        <div onclick="toggleChartSection('chartsContainer2')" class="flex items-center justify-between p-2 bg-gray-200 hover:bg-gray-300 cursor-pointer rounded-t-2xl chart-toggle-button">
            <h3 class="text-xl font-bold text-gray-800">ğŸ’° Kategorik Maliyet DaÄŸÄ±lÄ±m Grafikleri (Parasal BazlÄ±)</h3>
            <svg id="chartsContainer2Arrow" class="w-6 h-6 text-gray-600 transition-transform duration-300 transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
        
        <div id="chartsContainer2" class="flex gap-4 p-4 bg-white rounded-b-2xl transition-all duration-300">
            <div id="chartCurrentCostContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartCurrentCost"></canvas>
            </div>
            <div id="chartTenderCostContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartTenderCost"></canvas>
            </div>
        </div>
    </div>
    <div class="mb-6 border-b border-gray-300">
        <div onclick="toggleSummarySection()" class="flex items-center justify-between p-2 bg-gray-200 hover:bg-gray-300 cursor-pointer rounded-t-2xl summary-toggle-button">
            <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ Genel Stok ve Maliyet Ã–zeti</h3>
            <svg id="summaryContainerArrow" class="w-6 h-6 text-gray-600 transition-transform duration-300 transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
        <div id="summaryContainer" class="flex flex-wrap justify-around gap-4 p-4 bg-white rounded-b-2xl shadow-md transition-all duration-300">
            </div>
    </div>
    <div id="settingsCanvas" class="mb-6 p-4 bg-white rounded-2xl shadow-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">âš™ï¸ Rapor AyarlarÄ±</h3>
        
        <div class="flex flex-wrap justify-around items-start gap-6">
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[250px]">
                <p class="font-semibold text-gray-700 mb-2">Kritik Stok EÅŸikleri (Ay)</p>
                <div class="flex gap-4">
                    <div class="flex items-center gap-1">
                        <label for="criticalThreshold" class="text-sm font-medium text-gray-700">Kritik (<):</label>
                        <input type="number" id="criticalThreshold" value="6" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-red-300 rounded text-center text-sm">
                    </div>
                    <div class="flex items-center gap-1">
                        <label for="warningThreshold" class="text-sm font-medium text-gray-700">UyarÄ± (<):</label>
                        <input type="number" id="warningThreshold" value="8" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-yellow-300 rounded text-center text-sm">
                    </div>
                </div>
            </div>
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[350px]">
                <label class="font-semibold text-gray-700 block mb-2">SatÄ±r Renklendirme Ã–lÃ§Ã¼tÃ¼:</label>
                <div class="flex items-center gap-4">
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisAfterTender" name="rowColorBasis" value="ihaleSonrasi" 
                               onchange="setRowColorBasis(this.value)" checked 
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisAfterTender" class="ml-1 text-sm text-gray-700">Ä°hale SonrasÄ± Durum</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisCurrent" name="rowColorBasis" value="mevcutStok" 
                               onchange="setRowColorBasis(this.value)"
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisCurrent" class="ml-1 text-sm text-gray-700">Mevcut Stok Durumu</label>
                    </div>
                </div>
            </div>

            <div class="relative inline-block text-left border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[200px]">
                <button onclick="toggleCategorySettings()" class="w-full bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    â˜° Kategori Filtrelerini YÃ¶net
                </button>

                <div id="categoryDropdown" class="dropdown-menu origin-top-right absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2 max-h-64 overflow-y-auto">
                    <p class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">GÃ¶sterilecek Kategorileri SeÃ§in:</p>
                    
                    <div class="flex justify-between mb-2">
                        <a href="#" onclick="toggleAllCategories(true); return false;" class="text-xs text-custom-blue hover:text-custom-darkblue font-semibold">TÃ¼mÃ¼nÃ¼ SeÃ§</a>
                        <a href="#" onclick="toggleAllCategories(false); return false;" class="text-xs text-red-500 hover:text-red-700 font-semibold">TÃ¼mÃ¼nÃ¼ KaldÄ±r</a>
                    </div>

                    <div id="categoryCheckboxes" class="space-y-1">
                        </div>
                </div>
            </div>
            
            <div class="relative inline-block text-left border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[200px]">
                <button onclick="toggleColumnSettings()" class="w-full bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    âœ“ SÃ¼tun AyarlarÄ±nÄ± GÃ¶ster/Gizle
                </button>

                <div id="columnDropdown" class="dropdown-menu origin-top-right absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2">
                    <p class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">GÃ¶sterilecek SÃ¼tunlarÄ± SeÃ§in:</p>
                    
                    <div class="flex justify-between mb-2">
                        <a href="#" onclick="toggleAllColumns(true); return false;" class="text-xs text-custom-blue hover:text-custom-darkblue font-semibold">TÃ¼mÃ¼nÃ¼ SeÃ§</a>
                        <a href="#" onclick="toggleAllColumns(false); return false;" class="text-xs text-red-500 hover:text-red-700 font-semibold">TÃ¼mÃ¼nÃ¼ KaldÄ±r</a>
                    </div>
                    
                    <div id="columnCheckboxes" class="space-y-1">
                        </div>
                </div>
            </div>

        </div>
    </div>
    
    <div id="rangeFilterCanvas" class="mb-6 p-4 bg-white rounded-2xl shadow-md hidden-for-print">
        
        <div onclick="toggleRangeFilterSection()" class="flex justify-between items-center border-b pb-2 mb-4 bg-gray-100 p-2 rounded-t-lg hover:bg-gray-200 cursor-pointer">
            <h3 class="text-xl font-bold text-gray-800">ğŸ” SayÄ±sal AralÄ±k Filtreleri</h3>
            <div class="flex items-center gap-4">
                <button onclick="clearRangeFilters(); event.stopPropagation();" 
                        class="bg-gray-400 hover:bg-gray-500 text-white py-1 px-3 rounded-lg shadow-md transition duration-150 text-sm">
                    Temizle
                </button>
                 <svg id="rangeFilterCanvasArrow" class="w-6 h-6 text-gray-600 transition-transform duration-300 transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </div>
        
        <div id="rangeFilterContent" class="hidden"> 
            <div id="rangeFilterInputs" class="flex flex-wrap gap-6 justify-start">
                </div>
        </div>
    </div>
    
    <div id="legendContainer" class="mb-4">
        
        <div class="flex flex-col gap-2 w-full md:w-auto md:min-w-[300px] mb-2 md:mb-0">
             <label for="materialMultiSelect" class="text-sm font-medium text-gray-700 hidden md:block">Malzemeye GÃ¶re Ã‡oklu Filtre:</label>
             <select id="materialMultiSelect" multiple class="w-full"></select>
        </div>
        
        <button onclick="clearMaterialFilter()" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Malzeme Filtresini Temizle</button>
        
        <div class="flex flex-wrap justify-center items-center gap-3">
            </div>

    </div>
    <div id="tableContainer" class="bg-white p-4 rounded-2xl shadow-md table-responsive"></div>
    
    <script>
        let allRows = [];
        let chartCurrentInstance = null;
        let chartTenderInstance = null;
        let chartCurrentCostInstance = null; 
        let chartTenderCostInstance = null;  
        let currentSort = { column: null, asc: true };
        let rowColorBasis = 'ihaleSonrasi';  
        let currentFilter = 'hepsi';  
        let materialTomSelect = null; 
        
        let categorySelection = {}; 

        // EÅŸik DeÄŸerleri
        let criticalThreshold = 6;  
        let warningThreshold = 8;  
        
        // Local Storage AnahtarlarÄ±
        const LOCAL_STORAGE_DATA_KEY = 'raporData';
        const LOCAL_STORAGE_REPORT_INFO_KEY = 'raporInfo';

        // SÃ¼tun gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ durumu (Birim artÄ±k sabit deÄŸil, isteÄŸe baÄŸlÄ± kapatÄ±labilir)
        let columnVisibility = {
            'Kategori': false, 
            'Malzeme AdÄ±': true, 
            'Birim': true, // VarsayÄ±lan olarak gÃ¶rÃ¼nÃ¼r, ancak deÄŸiÅŸtirilebilir
            'Mevcut Stok': true, 
            'Birim Fiyat': false, 
            'Mevcut Stok DeÄŸeri': false, 
            'YÄ±llÄ±k TÃ¼ketim': true, 
            'Ambara teslim edilecek': true, 
            'Ambara Teslim Edilecek Maliyeti': false, 
            'KaÃ§ Ay Yeter': true, 
            'Ä°hale SonrasÄ± KaÃ§ Ay Yeter': true, 
            'AÃ§Ä±klama': true 
        };

        // SÃ¼tunlarÄ±n gÃ¶sterim sÄ±rasÄ± ve BAÅLIKLARI
        const columnOrder = [
            { key: 'Kategori', label: 'Malzeme Kategorisi' }, 
            { key: 'Malzeme AdÄ±', label: 'Malzeme AdÄ±' },
            { key: 'Birim', label: 'Birim' }, // Yeni sÃ¼tun
            { key: 'Mevcut Stok', label: 'Mevcut Stok (Miktar)' }, 
            { key: 'Birim Fiyat', label: 'Birim Fiyat (â‚º)' }, 
            { key: 'Mevcut Stok DeÄŸeri', label: 'Mevcut Stok DeÄŸeri (â‚º)' }, 
            { key: 'YÄ±llÄ±k TÃ¼ketim', label: 'YÄ±llÄ±k TÃ¼ketim (Miktar)' }, 
            { key: 'Ambara teslim edilecek', label: 'Ambara Teslim Edilecek (Miktar)' }, 
            { key: 'Ambara Teslim Edilecek Maliyeti', label: 'Teslim Edilecek Maliyeti (â‚º)' }, 
            { key: 'KaÃ§ Ay Yeter', label: 'Mevcut Stok KaÃ§ Ay Devam Eder' }, 
            { key: 'Ä°hale SonrasÄ± KaÃ§ Ay Yeter', label: 'Teslim SonrasÄ± KaÃ§ Ay Devam Eder' }, 
            { key: 'AÃ§Ä±klama', label: 'AÃ§Ä±klama' }
        ];
        
        // Parasal sÃ¼tun anahtarlarÄ±nÄ± belirleme
        const currencyKeys = [
            'Birim Fiyat', 
            'Mevcut Stok DeÄŸeri', 
            'Ambara Teslim Edilecek Maliyeti'
        ];
        
        // SayÄ±sal filtre anahtarlarÄ±
        const numericFilterKeys = [
            'Mevcut Stok', 'Birim Fiyat', 'Mevcut Stok DeÄŸeri', 
            'YÄ±llÄ±k TÃ¼ketim', 'Ambara teslim edilecek', 
            'Ambara Teslim Edilecek Maliyeti', 'KaÃ§ Ay Yeter', 
            'Ä°hale SonrasÄ± KaÃ§ Ay Yeter'
        ];

        // Grafik renk paleti
        const chartColors = [
            '#ef4444', '#f97316', '#facc15', '#22c55e', '#3b82f6', 
            '#9333ea', '#db2777', '#06b6d4', '#f472b6', '#a3a3a3'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadThresholds();  
            initializeColumnSettings();
            renderLegend(); 
            
            initializeMaterialMultiSelect();
            
            // Local Storage'dan veri yÃ¼kle, eÄŸer yoksa sadece filtreleri uygula (boÅŸ veri ile)
            if (!loadDataFromLocalStorage()) {
                initializeRangeFilters(); 
                applyFilters(); 
            }

            // Grafik ve Ã–zet bÃ¶lÃ¼mlerini varsayÄ±lan olarak aÃ§Ä±k tut
            document.getElementById('chartsContainer').classList.remove('hidden-for-print');
            document.getElementById('chartsContainer2').classList.remove('hidden-for-print');
            document.getElementById('summaryContainer').classList.remove('hidden-for-print');
        });

        // GRAFÄ°K VE Ã–ZET GÄ°ZLEME/GÃ–STERME FONKSÄ°YONLARI (DEÄÄ°ÅMEDÄ°)
        function toggleChartSection(containerId) {
            const container = document.getElementById(containerId);
            const arrow = document.getElementById(containerId + 'Arrow');
            
            if (container.classList.contains('hidden-for-print') || container.style.display === 'none') {
                container.classList.remove('hidden-for-print');
                container.style.display = 'flex'; 
                arrow.classList.add('rotate-180');
                arrow.classList.remove('rotate-0');
            } else {
                container.classList.add('hidden-for-print');
                container.style.display = 'none'; 
                arrow.classList.remove('rotate-180');
                arrow.classList.add('rotate-0');
            }
        }
        
        function toggleSummarySection() {
            const container = document.getElementById('summaryContainer');
            const arrow = document.getElementById('summaryContainerArrow');
            
            if (container.classList.contains('hidden-for-print') || container.style.display === 'none') {
                container.classList.remove('hidden-for-print');
                container.style.display = 'flex'; 
                arrow.classList.add('rotate-180');
                arrow.classList.remove('rotate-0');
            } else {
                container.classList.add('hidden-for-print');
                container.style.display = 'none'; 
                arrow.classList.remove('rotate-180');
                arrow.classList.add('rotate-0');
            }
        }


        // Para birimi formatlayÄ±cÄ± (2 ondalÄ±k basamak, â‚º simgesi) (DEÄÄ°ÅMEDÄ°)
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '';
            return value.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function formatCurrencySymbol(value) {
            if (typeof value !== 'number' || isNaN(value)) return '';
            return value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // SayÄ± formatlayÄ±cÄ± (Miktar alanlarÄ± iÃ§in) (DEÄÄ°ÅMEDÄ°)
        function formatNumber(value, decimals = 0) {
            if (typeof value !== 'number' || isNaN(value)) return '';
            return value.toLocaleString('tr-TR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }


        // DiÄŸer toggle ve update fonksiyonlarÄ± (DEÄÄ°ÅMEDÄ°)
        function toggleAllCategories(shouldSelect) {
            const checkboxes = document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                const categoryKey = checkbox.id.substring(4).replace(/-/g, ' '); 
                checkbox.checked = shouldSelect;
                categorySelection[categoryKey] = shouldSelect;
            });
            applyFilters();
        }

        // TOGGLE ALL COLUMNS GÃœNCELLENDÄ° (Birim artÄ±k sabit deÄŸil)
        function toggleAllColumns(shouldSelect) {
            // Sadece Malzeme AdÄ± sÃ¼tunu sabit kalacak
            const nonFixedColumns = columnOrder.filter(col => col.key !== 'Malzeme AdÄ±'); 

            nonFixedColumns.forEach(col => {
                const checkbox = document.getElementById(`col-${col.key.replace(/\s/g, '-')}`);
                if (checkbox) {
                    checkbox.checked = shouldSelect;
                    columnVisibility[col.key] = shouldSelect;
                }
            });
            columnVisibility['Malzeme AdÄ±'] = true; // Malzeme AdÄ± sabit
            applyFilters();
        }

        function toggleCategorySettings() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('hidden');
        }

        function updateCategorySelection(isSelected, categoryKey) {
            categorySelection[categoryKey] = isSelected;
            applyFilters();
        }
        
        function setRowColorBasis(basis) {
            rowColorBasis = basis;
            applyFilters();
        }

        // CSV YÃœKLEME VE PARSE Ä°ÅLEMLERÄ° (Birim sÃ¼tunu eklendi)
        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) { alert('LÃ¼tfen bir CSV dosyasÄ± seÃ§in.'); return; }
            const reader = new FileReader();
            
            reader.onload = e => {
                parseCSV(e.target.result);
                saveDataToLocalStorage(); 
            };

            reader.readAsText(file, 'UTF-8');
            
            const now = new Date();
            const dateString = now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR');
            const reportInfo = document.getElementById('reportInfo');
            reportInfo.value = dateString;  
        }

        function parseValue(value) {
            if (!value) return 0;
            return parseFloat(String(value).replace(/\s/g, '').replace(',', '.')); 
        }

        function parseCSV(csvText) {
            csvText = csvText.replace(/\uFEFF/g, '').trim();
            const parsed = Papa.parse(csvText, { 
                header: true, 
                skipEmptyLines: true,
                delimiter: ';', 
            });
            
            const categories = new Set(); 
            const materialNames = new Set(); 

            allRows = parsed.data.map(r => {
                const birimFiyat = parseValue(r['Birim Fiyat']); 
                
                const yillik = parseValue(r['YÄ±llÄ±k TÃ¼ketim']);
                const stok = parseValue(r['Mevcut Stok']);
                
                const ihaleMiktari = parseValue(r['Ambara Teslim Edilecek']); 
                const ihaleAnahtar = 'Ambara teslim edilecek'; 
                const birim = (r['Birim'] || 'Adet').trim(); // Birim sÃ¼tununu oku

                const aylik = yillik/12;

                const category = (r['Kategori'] || 'TanÄ±msÄ±z').trim(); 
                const material = (r['Malzeme AdÄ±']||'').trim(); 
                
                if (category) categories.add(category);
                if (material) materialNames.add(material);


                return {
                    'Kategori': category, 
                    'Malzeme AdÄ±': material,
                    'Birim': birim, // Birim alanÄ±nÄ± ekle
                    'Mevcut Stok': stok,
                    'Birim Fiyat': birimFiyat, 
                    'Mevcut Stok DeÄŸeri': stok * birimFiyat, 
                    'YÄ±llÄ±k TÃ¼ketim': yillik,
                    
                    [ihaleAnahtar]: ihaleMiktari, 
                    'Ambara Teslim Edilecek Maliyeti': ihaleMiktari * birimFiyat, 
                    
                    'KaÃ§ Ay Yeter': aylik ? stok / aylik : 0,
                    'Ä°hale SonrasÄ± KaÃ§ Ay Yeter': aylik ? (stok + ihaleMiktari) / aylik : 0,
                    'AÃ§Ä±klama': (r['AÃ§Ä±klama']||'').trim()
                };
            }).filter(r=>r['Malzeme AdÄ±']);
            
            initializeCategorySettings(categories);
            populateMaterialFilter(materialNames); 
            initializeRangeFilters(); 

            applyFilters();
        }

        // LOCAL STORAGE FONKSÄ°YONLARI (DEÄÄ°ÅMEDÄ°)
        function saveDataToLocalStorage() {
            if (allRows.length > 0) {
                localStorage.setItem(LOCAL_STORAGE_DATA_KEY, JSON.stringify(allRows));
                
                const reportInfo = document.getElementById('reportInfo').value;
                localStorage.setItem(LOCAL_STORAGE_REPORT_INFO_KEY, reportInfo);
            }
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_DATA_KEY);
            const savedInfo = localStorage.getItem(LOCAL_STORAGE_REPORT_INFO_KEY);

            if (savedInfo) {
                document.getElementById('reportInfo').value = savedInfo;
            }

            if (savedData) {
                allRows = JSON.parse(savedData);
                
                const categories = new Set(allRows.map(r => r['Kategori']).filter(Boolean));
                const materialNames = new Set(allRows.map(r => r['Malzeme AdÄ±']).filter(Boolean));

                initializeCategorySettings(categories);
                populateMaterialFilter(materialNames); 
                
                initializeRangeFilters(); 

                applyFilters(); 
                return true; 
            }
            return false;
        }

        // KATEGORÄ° AYARLARI FONKSÄ°YONU (DEÄÄ°ÅMEDÄ°)
        function initializeCategorySettings(categories) {
            const container = document.getElementById('categoryCheckboxes');
            let html = '';
            
            Array.from(categories).forEach(cat => {
                if (!(cat in categorySelection)) {
                    categorySelection[cat] = true; 
                }
            });

            const sortedCategories = Array.from(categories).sort((a, b) => 
                a.localeCompare(b, 'tr', { sensitivity: 'base' })
            );

            sortedCategories.forEach(cat => {
                const isSelected = categorySelection[cat];
                const checked = isSelected ? 'checked' : '';
                const id = `cat-${cat.replace(/\s/g, '-')}`; 

                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="${id}"  
                               ${checked}
                               onchange="updateCategorySelection(this.checked, '${cat}')"  
                               class="h-4 w-4 text-custom-blue border-gray-300 rounded">
                        <label for="${id}" class="ml-2 text-sm text-gray-700">${cat}</label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // DÄ°ÄER FONKSÄ°YONLAR (DEÄÄ°ÅMEDÄ°)
        function initializeMaterialMultiSelect() {
             materialTomSelect = new TomSelect('#materialMultiSelect', {
                plugins: ['remove_button', 'clear_button'],
                valueField: 'value',
                labelField: 'text',
                searchField: ['text'],
                placeholder: 'Malzeme adÄ±na gÃ¶re seÃ§in veya arayÄ±n...',
                onInitialize: function() {
                    this.on('change', applyFilters);
                }
             });
        }
        
        function populateMaterialFilter(materialNames) {
            if (!materialTomSelect) return;

            materialTomSelect.clear(true);
            materialTomSelect.clearOptions();
            
            const sortedMaterialNames = Array.from(materialNames).sort((a, b) => 
                a.localeCompare(b, 'tr', { sensitivity: 'base' })
            );

            const options = sortedMaterialNames.map(name => ({
                value: name,
                text: name
            }));

            materialTomSelect.addOptions(options);
        }

        function updateThresholds() {
            const crit = parseFloat(document.getElementById('criticalThreshold').value);
            const warn = parseFloat(document.getElementById('warningThreshold').value);
            
            if (crit >= warn) {
                alert('Kritik EÅŸik (Ay) deÄŸeri, UyarÄ± EÅŸiÄŸi (Ay) deÄŸerinden kÃ¼Ã§Ã¼k olmalÄ±dÄ±r. LÃ¼tfen deÄŸerleri kontrol edin.');
                document.getElementById('criticalThreshold').value = criticalThreshold;  
                return;
            }

            criticalThreshold = crit;
            warningThreshold = warn;
            
            renderLegend();  
            applyFilters();  
        }
        
        function loadThresholds() {
            document.getElementById('criticalThreshold').value = criticalThreshold;
            document.getElementById('warningThreshold').value = warningThreshold;
        }

        // FÄ°LTRE BUTONLARINI RENDER EDER (DEÄÄ°ÅMEDÄ°)
        function renderLegend() {
            const container = document.querySelector('#legendContainer > div:last-child');
            
            const btnClass = 'py-1 px-3 rounded-lg border border-gray-300 hover:shadow-md transition duration-150';
            const activeClass = 'font-bold shadow-lg ring-2 ring-custom-blue';  

            const html = `
                <button onclick="setFilterAndApply('success')"  
                        class="${btnClass} bg-gray-100 hover:bg-gray-200 ${currentFilter === 'success' ? activeClass : ''}">
                    Stok Yeterli (> ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('warning')"  
                        class="${btnClass} bg-status-warning hover:bg-yellow-200 ${currentFilter === 'warning' ? activeClass : ''}">
                    Stok AzalÄ±yor (${criticalThreshold} - ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('danger')"  
                        class="${btnClass} bg-status-danger hover:bg-red-300 ${currentFilter === 'danger' ? activeClass : ''}">
                    Kritik Seviye (< ${criticalThreshold} Ay)
                </button>
                
                <button onclick="setFilterAndApply('hepsi')"  
                        class="${btnClass} bg-blue-200 hover:bg-blue-400 border-blue-400 ${currentFilter === 'hepsi' ? activeClass : ''}">
                    TÃ¼m Durumlar
                </button>
            `;
            container.innerHTML = html;
        }
        
        // SÃœTUN GÃ–RÃœNÃœRLÃœK AYARLARI GÃœNCELLENDÄ° (Birim artÄ±k sabit deÄŸil)
        function initializeColumnSettings() {
            const container = document.getElementById('columnCheckboxes');
            let html = '';
            
            columnOrder.forEach(col => {
                const checked = columnVisibility[col.key] ? 'checked' : '';
                // Sadece Malzeme AdÄ± sabit (disabled) kalacak
                const disabled = (col.key === 'Malzeme AdÄ±') ? 'disabled' : ''; 
                
                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="col-${col.key.replace(/\s/g, '-')}"  
                               data-column-key="${col.key}"  
                               ${checked} ${disabled}
                               onchange="updateColumnVisibility(this.checked, '${col.key}')"  
                               class="h-4 w-4 text-custom-blue border-gray-300 rounded">
                        <label for="col-${col.key.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 ${disabled ? 'opacity-50' : ''}">
                            ${col.label}
                        </label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function updateColumnVisibility(isVisible, key) {
             if (key === 'Malzeme AdÄ±') {
                // Malzeme AdÄ± kapatÄ±lamaz
                document.getElementById(`col-${key.replace(/\s/g, '-')}`).checked = true;
                return;
             }
            columnVisibility[key] = isVisible;
            applyFilters();  
        }
        
        function toggleColumnSettings() {
            const dropdown = document.getElementById('columnDropdown');
            dropdown.classList.toggle('hidden');
        }

        // ARALIK FÄ°LTRELEME FONKSÄ°YONLARI (DEÄÄ°ÅMEDÄ°)
        function initializeRangeFilters() {
            const container = document.getElementById('rangeFilterInputs');
            let html = '';

            numericFilterKeys.forEach(key => {
                const idBase = key.replace(/\s/g, '').replace(/[^\w]/g, ''); 
                
                let shortLabel = key;
                if (key.includes('Maliyeti')) shortLabel = key.replace('Maliyeti', 'Maliyeti (â‚º)');
                else if (key.includes('Ay Yeter')) shortLabel = key.replace('Devam Eder', 'Yeterlilik (Ay)');
                else if (key.includes('Mevcut Stok DeÄŸeri')) shortLabel = 'Mevcut Stok DeÄŸeri (â‚º)';
                else if (key.includes('Ambara teslim edilecek')) shortLabel = 'Teslim Edilecek (Miktar)';
                else if (key.includes('Mevcut Stok')) shortLabel = 'Mevcut Stok (Miktar)';
                else if (key.includes('YÄ±llÄ±k TÃ¼ketim')) shortLabel = 'YÄ±llÄ±k TÃ¼ketim (Miktar)';
                else if (key.includes('Birim Fiyat')) shortLabel = 'Birim Fiyat (â‚º)';


                html += `
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 flex flex-col min-w-[200px] shadow-sm">
                        <label class="text-xs font-semibold text-gray-700 mb-2">${shortLabel}</label>
                        <div class="flex gap-2">
                            <input type="number" id="${idBase}Min" 
                                   placeholder="Min" step="any"
                                   oninput="applyFilters()"
                                   class="w-1/2 p-1 border border-gray-300 rounded text-sm text-center focus:ring-custom-blue">
                            <input type="number" id="${idBase}Max" 
                                   placeholder="Max" step="any"
                                   oninput="applyFilters()"
                                   class="w-1/2 p-1 border border-gray-300 rounded text-sm text-center focus:ring-custom-blue">
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function getRangeFilterValues() {
            const filters = {};
            numericFilterKeys.forEach(key => {
                const idBase = key.replace(/\s/g, '').replace(/[^\w]/g, ''); 
                const minVal = parseFloat(document.getElementById(`${idBase}Min`).value);
                const maxVal = parseFloat(document.getElementById(`${idBase}Max`).value);
                
                if (!isNaN(minVal) || !isNaN(maxVal)) {
                    filters[key] = { min: isNaN(minVal) ? -Infinity : minVal, max: isNaN(maxVal) ? Infinity : maxVal };
                }
            });
            return filters;
        }
        
        function clearRangeFilters() {
            numericFilterKeys.forEach(key => {
                const idBase = key.replace(/\s/g, '').replace(/[^\w]/g, ''); 
                
                const minInput = document.getElementById(`${idBase}Min`);
                const maxInput = document.getElementById(`${idBase}Max`);
                
                if (minInput) minInput.value = '';
                if (maxInput) maxInput.value = '';
            });
            
            applyFilters(); 
        }

        // FÄ°LTRELEME VE TABLO Ä°ÅLEMLERÄ°
        
        function clearMaterialFilter() {
            if (materialTomSelect) {
                materialTomSelect.clear();
            }
            applyFilters();  
        }

        function setFilterAndApply(filterValue) {
            currentFilter = filterValue;  
            renderLegend();  
            applyFilters();
        }

        // renderTable fonksiyonu (Birim sÃ¼tununa gÃ¶re dÃ¼zenlendi)
        function renderTable(rows) {
            const container = document.getElementById('tableContainer');
            if (!rows.length){
                container.innerHTML = '<p class="text-center text-gray-500">GÃ¶sterilecek veri bulunamadÄ±.</p>';
                return;
            }

            const pageRows = rows;  

            let html = `<table class="min-w-full">
                <thead>
                    <tr>`;
            
            const visibleColumns = columnOrder.filter(col => columnVisibility[col.key]);
            
            visibleColumns.forEach((col, index) => {
                let cornerClass = '';
                if (index === 0) cornerClass = 'rounded-tl-2xl';
                if (index === visibleColumns.length - 1) cornerClass = 'rounded-tr-2xl';
                
                html += `
                    <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer ${cornerClass}"  
                        onclick="sortTable('${col.key}')">${col.label} â†•</th>
                `;
            });
            
            html += `</tr></thead><tbody>`;

            pageRows.forEach((r, index) => {
                
                let targetAy;
                if (rowColorBasis === 'mevcutStok') {
                    targetAy = r['KaÃ§ Ay Yeter'];
                } else {
                    targetAy = r['Ä°hale SonrasÄ± KaÃ§ Ay Yeter'];
                }
                
                let rowCls = 'status-success';
                if (targetAy < criticalThreshold) {
                    rowCls = 'status-danger';  
                } else if(targetAy < warningThreshold) {
                    rowCls = 'status-warning';
                }
                
                const isLastRow = index === pageRows.length - 1;  

                html += `<tr class="${rowCls}">`;
                
                visibleColumns.forEach((col, tdIndex) => {
                    let tdClass = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center';
                    
                    // Metin, Kategori ve Birim SÃ¼tunlarÄ±
                    if (col.key === 'Malzeme AdÄ±' || col.key === 'AÃ§Ä±klama' || col.key === 'Kategori' || col.key === 'Birim') { 
                        tdClass = 'px-6 py-4 whitespace-normal text-sm text-gray-900 ' + (col.key === 'Malzeme AdÄ±' || col.key === 'Kategori' ? 'text-left' : 'text-center');
                    }
                    
                    // Parasal SÃ¼tunlarÄ± SaÄŸa Hizalama
                    if (currencyKeys.includes(col.key)) {
                        tdClass = tdClass.replace('text-center', 'text-right');
                    } 

                    let cellValue = r[col.key];
                    
                    // Maliyet ve Birim FiyatÄ± formatla
                    if (currencyKeys.includes(col.key)) {
                        cellValue = formatCurrencySymbol(r[col.key]); 
                    } 
                    else if (col.key.includes('Ay Yeter')) {
                        if (typeof cellValue === 'number' && !isNaN(cellValue)) {
                            cellValue = cellValue.toFixed(1).replace('.', ','); 
                        }
                    } else if (typeof cellValue === 'number' && !isNaN(cellValue)) {
                        cellValue = formatNumber(cellValue); 
                    } else if (cellValue === null || cellValue === undefined) {
                        cellValue = '';
                    }

                    // YETERLÄ°LÄ°K SÃœTUNLARI Ä°Ã‡Ä°N Ã–ZEL RENK VE BOLD AYARLARI 
                    if (col.key === 'KaÃ§ Ay Yeter' || col.key === 'Ä°hale SonrasÄ± KaÃ§ Ay Yeter') {
                        const ayYeterlilik = r[col.key];
                        let textClass = 'text-gray-900';
                        
                        if (ayYeterlilik < criticalThreshold) {
                            textClass = 'font-bold text-red-600';
                        } else if (ayYeterlilik < warningThreshold) {
                            textClass = 'font-bold text-yellow-700';
                        } else {
                            textClass = 'font-bold text-green-600';
                        }
                        
                        tdClass += ' ' + textClass;
                    }  

                    if (isLastRow) {
                        if (tdIndex === 0) tdClass += ' rounded-bl-lg';
                        if (tdIndex === visibleColumns.length - 1) tdClass += ' rounded-br-lg';
                    }

                    html += `<td class="${tdClass}">${cellValue}</td>`;
                });

                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function sortTable(col){
            const asc = currentSort.column===col?!currentSort.asc:true;
            currentSort={column:col,asc};
            
            allRows.sort((a,b)=>{
                const valA=a[col]||'';
                const valB=b[col]||'';
                
                if (typeof valA === 'string' && typeof valB === 'string') {
                    const comparison = valA.localeCompare(valB, 'tr', { sensitivity: 'base' });
                    return asc ? comparison : -comparison;
                } else {
                    const numA = parseFloat(valA) || 0;
                    const numB = parseFloat(valB) || 0;
                    return asc ? numA - numB : numB - numA;
                }
            });

            applyFilters();
        }

        // calculateSummary fonksiyonu (Birim bazÄ±nda gruplama yapacak ÅŸekilde gÃ¼ncellendi)
        function calculateSummary(rows) {
            const unitSummaries = {}; 
            let totalCurrentCost = 0;
            let totalTenderCost = 0;
            let totalItemCount = rows.length;

            rows.forEach(r => {
                const birim = r['Birim'] || 'Adet'; 
                
                if (!unitSummaries[birim]) {
                    unitSummaries[birim] = {
                        currentStock: 0,
                        tenderQuantity: 0
                    };
                }
                
                unitSummaries[birim].currentStock += r['Mevcut Stok'];
                unitSummaries[birim].tenderQuantity += r['Ambara teslim edilecek'];
                
                totalCurrentCost += r['Mevcut Stok DeÄŸeri'];
                totalTenderCost += r['Ambara Teslim Edilecek Maliyeti'];
            });

            return {
                unitSummaries, 
                totalCurrentCost,
                totalTenderCost,
                totalItemCount
            };
        }

        // renderSummary fonksiyonu (Maliyet kartlarÄ± ayrÄ± satÄ±rda olacak ÅŸekilde gÃ¼ncellendi)
        function renderSummary(summaryData) {
            const container = document.getElementById('summaryContainer');

            if (summaryData.totalItemCount === 0) {
                 container.innerHTML = '<p class="text-center text-gray-500">Ã–zet: Filtreleme sonucu malzeme bulunamadÄ±.</p>';
                 return;
            }

            const totalMaliyet = summaryData.totalCurrentCost + summaryData.totalTenderCost;

            // --- MÄ°KTAR KARTLARI ---
            let quantityCards = [
                { title: "Filtrelenen Malzeme Ã‡eÅŸidi", value: formatNumber(summaryData.totalItemCount), icon: 'ğŸ“¦' }
            ];

            // Birim BazlÄ± Miktar KartlarÄ±nÄ± Ekleme
            Object.keys(summaryData.unitSummaries).forEach(birim => {
                const data = summaryData.unitSummaries[birim];
                const totalStock = data.currentStock + data.tenderQuantity;
                
                quantityCards.push({
                    title: `Mevcut Stok Toplam Miktar (${birim})`, 
                    value: formatNumber(data.currentStock) + ' ' + birim, 
                    icon: 'âœ…' 
                });
                quantityCards.push({
                    title: `Teslim Edilecek Toplam Miktar (${birim})`, 
                    value: formatNumber(data.tenderQuantity) + ' ' + birim, 
                    icon: 'ğŸš›' 
                });
                quantityCards.push({
                    title: `Genel Toplam Miktar (${birim})`, 
                    value: formatNumber(totalStock) + ' ' + birim, 
                    icon: 'ğŸ“Š' 
                });
            });

            // --- MALÄ°YET KARTLARI ---
            let costCards = [
                { title: "Mevcut Stok Toplam DeÄŸeri", value: formatCurrencySymbol(summaryData.totalCurrentCost), icon: 'ğŸ’°', color: 'text-custom-blue' },
                { title: "Teslim Edilecek Toplam Maliyet", value: formatCurrencySymbol(summaryData.totalTenderCost), icon: 'ğŸ’¸', color: 'text-orange-500' },
                { title: "Genel Toplam Maliyet (â‚º)", value: formatCurrencySymbol(totalMaliyet), icon: 'â­', color: 'text-green-600' }
            ];

            // KartlarÄ± HTML'e dÃ¶nÃ¼ÅŸtÃ¼ren yardÄ±mcÄ± fonksiyon
            const mapCardsToHTML = (cards, sizeClass) => cards.map(card => `
                <div class="bg-gray-50 p-4 border border-gray-200 rounded-lg shadow-inner flex-1 ${sizeClass}">
                    <p class="text-sm font-medium text-gray-500 truncate">${card.icon} ${card.title}</p>
                    <p class="mt-1 text-2xl font-extrabold ${card.color || 'text-gray-900'}">${card.value}</p>
                </div>
            `).join('');
            
            // Miktar kartlarÄ± iÃ§in daha esnek boyutlandÄ±rma
            const quantityHtml = mapCardsToHTML(quantityCards, 'min-w-[200px] max-w-[calc(50%-8px)] md:max-w-[calc(25%-8px)]');

            // Maliyet kartlarÄ± iÃ§in tam geniÅŸlikte yeni bir satÄ±r oluÅŸturma
            const costHtml = mapCardsToHTML(costCards, 'min-w-[250px] max-w-[calc(50%-8px)] md:max-w-[calc(33.333%-8px)]');


            // SonuÃ§ HTML'i (AyrÄ± satÄ±rlarda)
            container.innerHTML = `
                <div class="flex flex-wrap justify-around gap-4 w-full">
                    ${quantityHtml}
                </div>
                <div class="w-full h-px bg-gray-200 my-2"></div> <div class="flex flex-wrap justify-around gap-4 w-full">
                    ${costHtml}
                </div>
            `;
        }

        function applyFilters(){
            const selectedMaterials = materialTomSelect ? materialTomSelect.getValue() : [];
            const rangeFilters = getRangeFilterValues(); 
            const filter = currentFilter;  
            
            const selectedCategories = Object.keys(categorySelection).filter(key => categorySelection[key]);

            let filtered = allRows;
            
            // 1. Kategoriye gÃ¶re filtreleme
            if (Object.keys(categorySelection).length > 0) {
                filtered = filtered.filter(r => selectedCategories.includes(r['Kategori']));
            }
            
            // 2. Malzeme AdÄ±na gÃ¶re filtreleme (Ã‡oklu SeÃ§im)
            if (selectedMaterials.length > 0) {
                filtered = filtered.filter(r => selectedMaterials.includes(r['Malzeme AdÄ±']));
            }
            
            // 3. SayÄ±sal AralÄ±k Filtreleme 
            Object.keys(rangeFilters).forEach(key => {
                const { min, max } = rangeFilters[key];
                filtered = filtered.filter(r => {
                    const value = r[key] || 0; 
                    return value >= min && value <= max;
                });
            });


            // 4. Stok YeterliliÄŸi durumuna gÃ¶re filtreleme
            const filterBasis = (rowColorBasis === 'mevcutStok') ? 'KaÃ§ Ay Yeter' : 'Ä°hale SonrasÄ± KaÃ§ Ay Yeter';

            if(filter !== 'hepsi'){
                filtered = filtered.filter(r=>{
                    const ay=r[filterBasis];  
                    if(filter==='success') return ay>=warningThreshold;
                    if(filter==='warning') return ay>=criticalThreshold && ay<warningThreshold;
                    if(filter==='danger') return ay<criticalThreshold;
                });
            }
            
            // Ã–ZET VE GRAFÄ°K VERÄ°LERÄ°NÄ° HESAPLA VE GÃ–RÃœNTÃœLE
            const summaryData = calculateSummary(filtered);
            renderSummary(summaryData); 

            renderTable(filtered);
            renderCurrentChart(filtered);  
            renderTenderChart(filtered);  
            renderLegend(); 

            // GÃœNCELLENMÄ°Å MALÄ°YET HESAPLAMASI
            const costData = calculateCategoryCosts(filtered);
            renderCurrentCostChart(costData.current);
            renderTenderCostChart(costData.tender);
            
            saveDataToLocalStorage();
        }

        function exportPDF(){ window.print(); }

        function formatDaysToMonths(totalDays) {
            if (totalDays < 0) return '0 GÃ¼n (TÃ¼kendi)';
            const daysPerMonth = 30;
            const months = Math.floor(totalDays / daysPerMonth);
            const remainingDays = Math.round(totalDays % daysPerMonth);
            
            let result = [];
            if (months > 0) result.push(months + ' Ay');
            if (remainingDays > 0 || months === 0) {
                result.push(remainingDays + ' GÃ¼n');
            }
            
            return result.join(' ');
        }
        
        // MALÄ°YET HESAPLAMA VE Ä°KÄ°LÄ° SIRALAMA FONKSÄ°YONU (DEÄÄ°ÅMEDÄ°)
        function calculateCategoryCosts(rows) {
            const costs = {};
            let totalCurrentCost = 0;
            let totalTenderCost = 0;

            rows.forEach(r => {
                const category = r['Kategori'];
                const currentCost = r['Mevcut Stok DeÄŸeri'];
                const tenderCost = r['Ambara Teslim Edilecek Maliyeti'];

                if (!costs[category]) {
                    costs[category] = { current: 0, tender: 0 };
                }

                costs[category].current += currentCost;
                costs[category].tender += tenderCost;
                
                totalCurrentCost += currentCost;
                totalTenderCost += tenderCost;
            });

            const allCategories = Object.keys(costs).map(key => ({
                category: key,
                current: costs[key].current,
                tender: costs[key].tender
            }));
            
            const sortedCurrent = [...allCategories].sort((a, b) => b.current - a.current).slice(0, 10);
            const sortedTender = [...allCategories].sort((a, b) => b.tender - a.tender).slice(0, 10);

            return {
                current: {
                    labels: sortedCurrent.map(c => c.category),
                    costs: sortedCurrent.map(c => c.current),
                    totalCost: totalCurrentCost,
                },
                tender: {
                    labels: sortedTender.map(c => c.category),
                    costs: sortedTender.map(c => c.tender),
                    totalCost: totalTenderCost,
                }
            };
        }

        // GRAFÄ°K FONKSÄ°YONLARI (DEÄÄ°ÅMEDÄ°)
        function renderCurrentChart(rows){
            const ctx=document.getElementById('chartCurrent').getContext('2d');
            const safeRows = [...rows];  
            
            const critical = safeRows.sort((a,b)=>a['KaÃ§ Ay Yeter']-b['KaÃ§ Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme AdÄ±']);
            const values = critical.map(r=>r['KaÃ§ Ay Yeter']*30);  

            if(chartCurrentInstance) chartCurrentInstance.destroy();
            
            chartCurrentInstance = new Chart(ctx,{
                type:'bar',
                data:{ labels, datasets:[{
                    label:'Kalan Stok (Ay/GÃ¼n)',  
                    data:values,  
                    backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']  
                }]},
                options:{
                    indexAxis:'y',  
                    responsive:true,  
                    maintainAspectRatio: false,  
                    
                    layout: {
                        padding: { left: 20, right: 80 }  
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki Ä°lk 5 Malzeme (Mevcut Stok YeterliliÄŸi)',  
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'  
                        },
                        datalabels:{  
                            anchor:'end',  
                            align:'right',  
                            formatter: value=>formatDaysToMonths(value)  
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTenderChart(rows){
            const ctx=document.getElementById('chartAfterTender').getContext('2d');
            const safeRows = [...rows];  
            
            const critical = safeRows.sort((a,b)=>a['Ä°hale SonrasÄ± KaÃ§ Ay Yeter']-b['Ä°hale SonrasÄ± KaÃ§ Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme AdÄ±']);
            const values = critical.map(r=>r['Ä°hale SonrasÄ± KaÃ§ Ay Yeter']*30);  

            if(chartTenderInstance) chartTenderInstance.destroy();
            
            chartTenderInstance = new Chart(ctx,{
                type:'bar',
                data:{  
                    labels,  
                    datasets:[{
                        label:'Kalan Stok (Ay/GÃ¼n)',  
                        data:values,  
                        backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']  
                    }]
                },
                options:{
                    indexAxis:'y',  
                    responsive:true,  
                    maintainAspectRatio: false,  
                    
                    layout: {
                        padding: { left: 20, right: 80 }  
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki Ä°lk 5 Malzeme (Teslim SonrasÄ± Yeterlilik)',  
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'  
                        },
                        datalabels:{  
                            anchor:'end',  
                            align:'right',  
                            formatter: value=>formatDaysToMonths(value)  
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function renderCurrentCostChart(costData) {
            const ctx = document.getElementById('chartCurrentCost').getContext('2d');
            
            if (chartCurrentCostInstance) chartCurrentCostInstance.destroy();

            chartCurrentCostInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: costData.labels,
                    datasets: [{
                        label: 'Mevcut Stok DeÄŸeri',
                        data: costData.costs,
                        backgroundColor: chartColors[4], 
                        borderColor: chartColors[4],
                        borderWidth: 1,
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                     layout: {
                        padding: { left: 0, right: 80 }  
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `En YÃ¼ksek 10 Kategorinin Mevcut Stok DeÄŸeri (Toplam: ${formatCurrencySymbol(costData.totalCost)})`,
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            formatter: (value) => {
                                return formatCurrency(value) + ' â‚º'; 
                            },
                            color: '#333',
                            font: {
                                weight: 'bold',
                                size: 12
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true },
                        y: { reverse: true } 
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTenderCostChart(costData) {
            const ctx = document.getElementById('chartTenderCost').getContext('2d');

            if (chartTenderCostInstance) chartTenderCostInstance.destroy();

            chartTenderCostInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: costData.labels, 
                    datasets: [{
                        label: 'Ambara Teslim Edilecek Maliyeti',
                        data: costData.costs,
                        backgroundColor: chartColors[2], 
                        borderColor: chartColors[2],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { left: 0, right: 80 }  
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `En YÃ¼ksek 10 Kategorinin Teslim Edilecek Stok Maliyeti (Toplam: ${formatCurrencySymbol(costData.totalCost)})`,
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            formatter: (value) => {
                                return formatCurrency(value) + ' â‚º'; 
                            },
                            color: '#333',
                            font: {
                                weight: 'bold',
                                size: 12
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true },
                        y: { reverse: true } 
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // SayÄ±sal AralÄ±k Filtreleri panelini aÃ§Ä±p kapatma fonksiyonu
        function toggleRangeFilterSection() {
            const content = document.getElementById('rangeFilterContent');
            const arrow = document.getElementById('rangeFilterCanvasArrow');
            
            // Toggle sÄ±nÄ±fÄ±nÄ± kullanarak gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ deÄŸiÅŸtirme
            content.classList.toggle('hidden');
            
            // Ok yÃ¶nÃ¼nÃ¼ gÃ¼ncelleme
            if (content.classList.contains('hidden')) {
                arrow.classList.remove('rotate-180');
            } else {
                arrow.classList.add('rotate-180');
            }
        }

    </script>
</body>
</html>

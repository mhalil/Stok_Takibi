<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Malzeme Stok Durumu ve Maliyet Analizi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v3.x.x/dist/cdn.min.js" defer></script>


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#2563eb',
                        'custom-darkblue': '#1e40af',
                        'status-warning': '#fff8dc', 
                        'status-danger': '#f8d7da',  
                        'zebra-strip': '#f3f4f6',    
                    }
                }
            }
        }
    </script>

    <style>
        /* Grafik taşıyıcılarına sabit yükseklik verilir */
        #chartCurrentContainer, #chartAfterTenderContainer, 
        #chartCurrentCostContainer, #chartTenderCostContainer {
            height: 350px;  
        }

        /* Tablo genişliklerini ve kaydırma çubuğunu yönetmek için */
        .table-responsive {
            overflow-x: auto;
        }
        
        /* Tablo stil */
        #tableContainer table {
            border-collapse: separate;
            border-spacing: 0 0.4rem; /* Dikey boşluk */
        }
        
        /* Renklendirme kuralları */
        tbody tr:nth-child(odd) {
            background-color: #f3f4f6 !important;  
        }
        #tableContainer tr.status-warning { background-color: #fff8dc !important; }  
        #tableContainer tr.status-danger { background-color: #f8d7da !important; }  
        
        /* Yazdırma ayarları */
        @media print {
            .mb-6 { margin-bottom: 0 !important; }  
            #chartsContainer, #chartsContainer2 { padding: 0 !important; }
            .controls, .legend, #settingsCanvas, .ts-control, .chart-toggle-button {  /* chart-toggle-button eklendi */
                display: none !important; 
            }
            h1 { margin-top: 0; }
            #tableContainer { box-shadow: none; padding: 0; }
            
            /* Gizlenmiş grafik kaplarını yazdırma anında da gizler */
            .hidden-for-print {
                display: none !important;
            }
        }

        /* Sütun ve Kategori Ayarları Menüsü İçin Özel CSS */
        .dropdown-menu {
            z-index: 10;
        }

        /* Tom Select için özel stil ayarlamaları (Tailwind'e uyum) */
        .ts-control {
            @apply p-2 border border-gray-300 rounded-lg shadow-sm w-full md:min-w-[300px] bg-white;
        }
        .ts-wrapper.multi .ts-control > div {
            @apply bg-custom-blue text-white rounded-md text-sm py-1 px-2;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body class="font-sans bg-gray-100 p-5">
    <h1 class="text-3xl font-bold text-center mb-1 text-gray-800">📊 ABONE İŞLERİ DAİRESİ BAŞKANLIKLARI AMBAR STOK DURUMU VE MALİYET ANALİZİ 🗠</h1>
    
    <input type="text" id="reportInfo" 
            placeholder="Rapor tarihini, versiyonunu veya ek notları buraya girin..." 
            class="block w-3/4 mx-auto text-center border-b border-gray-400 focus:outline-none focus:border-custom-blue p-1 mb-6 
                         text-lg font-bold text-gray-900 bg-transparent"
            value="">
    
    <div class="flex flex-wrap justify-center items-center gap-4 mb-6 p-4 bg-white rounded-2xl shadow-md controls">
        <input type="file" id="csvFile" accept=".csv" class="p-2 border border-gray-300 rounded-lg">
        <button onclick="loadCSV()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Yükle</button>
        
        <div class="flex flex-col gap-2 w-full md:w-auto md:min-w-[300px]">
             <label for="materialMultiSelect" class="text-sm font-medium text-gray-700 hidden md:block">Malzemeye Göre Çoklu Filtre:</label>
             <select id="materialMultiSelect" multiple class="w-full"></select>
        </div>
        
        <button onclick="clearMaterialFilter()" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Malzeme Filtresini Temizle</button>
        
        <button onclick="exportPDF()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">PDF Olarak Dışa Aktar</button>
    </div>

    <div id="settingsCanvas" class="mb-6 p-4 bg-white rounded-2xl shadow-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">⚙️ Rapor Ayarları</h3>
        
        <div class="flex flex-wrap justify-around items-start gap-6">
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[250px]">
                <p class="font-semibold text-gray-700 mb-2">Kritik Stok Eşikleri (Ay)</p>
                <div class="flex gap-4">
                    <div class="flex items-center gap-1">
                        <label for="criticalThreshold" class="text-sm font-medium text-gray-700">Kritik (<):</label>
                        <input type="number" id="criticalThreshold" value="6" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-red-300 rounded text-center text-sm">
                    </div>
                    <div class="flex items-center gap-1">
                        <label for="warningThreshold" class="text-sm font-medium text-gray-700">Uyarı (<):</label>
                        <input type="number" id="warningThreshold" value="8" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-yellow-300 rounded text-center text-sm">
                    </div>
                </div>
            </div>
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[350px]">
                <label class="font-semibold text-gray-700 block mb-2">Satır Renklendirme Ölçütü:</label>
                <div class="flex items-center gap-4">
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisAfterTender" name="rowColorBasis" value="ihaleSonrasi" 
                               onchange="setRowColorBasis(this.value)" checked 
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisAfterTender" class="ml-1 text-sm text-gray-700">İhale Sonrası Durum</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisCurrent" name="rowColorBasis" value="mevcutStok" 
                               onchange="setRowColorBasis(this.value)"
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisCurrent" class="ml-1 text-sm text-gray-700">Mevcut Stok Durumu</label>
                    </div>
                </div>
            </div>

            <div class="relative inline-block text-left border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[200px]">
                <button onclick="toggleCategorySettings()" class="w-full bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    ☰ Kategori Filtrelerini Yönet
                </button>

                <div id="categoryDropdown" class="dropdown-menu origin-top-right absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2 max-h-64 overflow-y-auto">
                    <p class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Gösterilecek Kategorileri Seçin:</p>
                    
                    <div class="flex justify-between mb-2">
                        <a href="#" onclick="toggleAllCategories(true); return false;" class="text-xs text-custom-blue hover:text-custom-darkblue font-semibold">Tümünü Seç</a>
                        <a href="#" onclick="toggleAllCategories(false); return false;" class="text-xs text-red-500 hover:text-red-700 font-semibold">Tümünü Kaldır</a>
                    </div>

                    <div id="categoryCheckboxes" class="space-y-1">
                        </div>
                </div>
            </div>
            
            <div class="relative inline-block text-left border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[200px]">
                <button onclick="toggleColumnSettings()" class="w-full bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    ✓ Sütun Ayarlarını Göster/Gizle
                </button>

                <div id="columnDropdown" class="dropdown-menu origin-top-right absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2">
                    <p class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Gösterilecek Sütunları Seçin:</p>
                    
                    <div class="flex justify-between mb-2">
                        <a href="#" onclick="toggleAllColumns(true); return false;" class="text-xs text-custom-blue hover:text-custom-darkblue font-semibold">Tümünü Seç</a>
                        <a href="#" onclick="toggleAllColumns(false); return false;" class="text-xs text-red-500 hover:text-red-700 font-semibold">Tümünü Kaldır</a>
                    </div>
                    
                    <div id="columnCheckboxes" class="space-y-1">
                        </div>
                </div>
            </div>

        </div>
    </div>
    
    <div class="mb-6 border-b border-gray-300">
        <div onclick="toggleChartSection('chartsContainer')" class="flex items-center justify-between p-2 bg-gray-200 hover:bg-gray-300 cursor-pointer rounded-t-2xl chart-toggle-button">
            <h3 class="text-xl font-bold text-gray-800">📈 Stok Yeterliliği Grafikleri (Ay Bazlı)</h3>
            <svg id="chartsContainerArrow" class="w-6 h-6 text-gray-600 transition-transform duration-300 transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
        
        <div id="chartsContainer" class="flex gap-4 p-4 bg-white rounded-b-2xl transition-all duration-300">
            <div id="chartCurrentContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartCurrent"></canvas>
            </div>
            <div id="chartAfterTenderContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartAfterTender"></canvas>
            </div>
        </div>
    </div>

    <div class="mb-6 border-b border-gray-300">
        <div onclick="toggleChartSection('chartsContainer2')" class="flex items-center justify-between p-2 bg-gray-200 hover:bg-gray-300 cursor-pointer rounded-t-2xl chart-toggle-button">
            <h3 class="text-xl font-bold text-gray-800">💰 Kategorik Maliyet Dağılım Grafikleri (Parasal Bazlı)</h3>
            <svg id="chartsContainer2Arrow" class="w-6 h-6 text-gray-600 transition-transform duration-300 transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
        
        <div id="chartsContainer2" class="flex gap-4 p-4 bg-white rounded-b-2xl transition-all duration-300">
            <div id="chartCurrentCostContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartCurrentCost"></canvas>
            </div>
            <div id="chartTenderCostContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartTenderCost"></canvas>
            </div>
        </div>
    </div>
    <div class="text-center mb-4 legend flex justify-center gap-4" id="legendContainer"></div>

    <div id="tableContainer" class="bg-white p-4 rounded-2xl shadow-md table-responsive overflow-hidden"></div>
    
    <script>
        let allRows = [];
        let chartCurrentInstance = null;
        let chartTenderInstance = null;
        let chartCurrentCostInstance = null; 
        let chartTenderCostInstance = null;  
        let currentSort = { column: null, asc: true };
        let rowColorBasis = 'ihaleSonrasi';  
        let currentFilter = 'hepsi';  
        let materialTomSelect = null; 
        
        let categorySelection = {}; 

        // Eşik Değerleri
        let criticalThreshold = 6;  
        let warningThreshold = 8;  
        
        // Sütun görünürlüğü durumu (İstenen Varsayılan Ayarlar)
        let columnVisibility = {
            'Kategori': false, 
            'Malzeme Adı': true, 
            'Mevcut Stok': true, 
            'Birim Fiyat': false, 
            'Mevcut Stok Değeri': false, 
            'Yıllık Tüketim': true, 
            'Ambara teslim edilecek': true, 
            'Ambara Teslim Edilecek Maliyeti': false, 
            'Kaç Ay Yeter': true, 
            'İhale Sonrası Kaç Ay Yeter': true, 
            'Açıklama': true 
        };

        // Sütunların gösterim sırası ve BAŞLIKLARI
        const columnOrder = [
            { key: 'Kategori', label: 'Malzeme Kategorisi' }, 
            { key: 'Malzeme Adı', label: 'Malzeme Adı' },
            { key: 'Mevcut Stok', label: 'Mevcut Stok (Miktar)' }, 
            { key: 'Birim Fiyat', label: 'Birim Fiyat (₺)' }, 
            { key: 'Mevcut Stok Değeri', label: 'Mevcut Stok Değeri (₺)' }, 
            { key: 'Yıllık Tüketim', label: 'Yıllık Tüketim (Miktar)' }, 
            { key: 'Ambara teslim edilecek', label: 'Ambara Teslim Edilecek (Miktar)' }, // BAŞLIK GÜNCELLENDİ
            { key: 'Ambara Teslim Edilecek Maliyeti', label: 'Teslim Edilecek Maliyeti (₺)' }, 
            { key: 'Kaç Ay Yeter', label: 'Mevcut Stok Kaç Ay Devam Eder' }, 
            { key: 'İhale Sonrası Kaç Ay Yeter', label: 'Teslim Sonrası Kaç Ay Devam Eder' }, 
            { key: 'Açıklama', label: 'Açıklama' }
        ];
        
        // Parasal sütun anahtarlarını belirleme
        const currencyKeys = [
            'Birim Fiyat', 
            'Mevcut Stok Değeri', 
            'Ambara Teslim Edilecek Maliyeti'
        ];
        
        // Grafik renk paleti (Pasta grafikleri için)
        const chartColors = [
            '#ef4444', '#f97316', '#facc15', '#22c55e', '#3b82f6', 
            '#9333ea', '#db2777', '#06b6d4', '#f472b6', '#a3a3a3'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadThresholds();  
            initializeColumnSettings();
            renderLegend();  
            
            initializeMaterialMultiSelect();

            applyFilters();  
        });

        // GRAFİK GİZLEME/GÖSTERME FONKSİYONU
        function toggleChartSection(containerId) {
            const container = document.getElementById(containerId);
            const arrow = document.getElementById(containerId + 'Arrow');
            
            // Gizleme/gösterme işlemleri
            if (container.classList.contains('hidden-for-print')) {
                // Göster
                container.classList.remove('hidden-for-print');
                container.style.display = 'flex'; 
                arrow.classList.add('rotate-180');
                arrow.classList.remove('rotate-0');
            } else {
                // Gizle
                container.classList.add('hidden-for-print');
                container.style.display = 'none'; 
                arrow.classList.remove('rotate-180');
                arrow.classList.add('rotate-0');
            }
        }


        // Para birimi formatlayıcı (2 ondalık basamak, ₺ simgesi)
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '';
            return value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Sayı formatlayıcı (Miktar alanları için)
        function formatNumber(value, decimals = 0) {
            if (typeof value !== 'number' || isNaN(value)) return '';
            return value.toLocaleString('tr-TR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }


        // Diğer toggle ve update fonksiyonları (Değişmedi)
        function toggleAllCategories(shouldSelect) {
            const checkboxes = document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                const categoryKey = checkbox.id.substring(4).replace(/-/g, ' '); 
                checkbox.checked = shouldSelect;
                categorySelection[categoryKey] = shouldSelect;
            });
            applyFilters();
        }

        function toggleAllColumns(shouldSelect) {
            const nonFixedColumns = columnOrder.filter(col => col.key !== 'Malzeme Adı'); 

            nonFixedColumns.forEach(col => {
                const checkbox = document.getElementById(`col-${col.key.replace(/\s/g, '-')}`);
                if (checkbox) {
                    checkbox.checked = shouldSelect;
                    columnVisibility[col.key] = shouldSelect;
                }
            });
            columnVisibility['Malzeme Adı'] = true; 
            applyFilters();
        }

        function toggleCategorySettings() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('hidden');
        }

        function updateCategorySelection(isSelected, categoryKey) {
            categorySelection[categoryKey] = isSelected;
            applyFilters();
        }

        function setRowColorBasis(basis) {
            rowColorBasis = basis;
            applyFilters();
        }

        // CSV YÜKLEME VE PARSE İŞLEMLERİ 
        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) { alert('Lütfen bir CSV dosyası seçin.'); return; }
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(file, 'UTF-8');
            
            const now = new Date();
            const dateString = now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR');
            const reportInfo = document.getElementById('reportInfo');
            reportInfo.value = dateString;  
        }

        function parseValue(value) {
            if (!value) return 0;
            return parseFloat(String(value).replace(/\s/g, '').replace(',', '.')); 
        }

        function parseCSV(csvText) {
            csvText = csvText.replace(/\uFEFF/g, '').trim();
            const parsed = Papa.parse(csvText, { 
                header: true, 
                skipEmptyLines: true,
                delimiter: ';', 
            });
            
            const categories = new Set(); // Kategori adlarını toplamak için Set
            const materialNames = new Set(); 

            allRows = parsed.data.map(r => {
                const birimFiyat = parseValue(r['Birim Fiyat']); 
                
                const yillik = parseValue(r['Yıllık Tüketim']);
                const stok = parseValue(r['Mevcut Stok']);
                
                // CSV'den 'Ambara Teslim Edilecek' başlığını kullanarak değeri okuyoruz
                const ihaleMiktari = parseValue(r['Ambara Teslim Edilecek']); 
                const ihaleAnahtar = 'Ambara teslim edilecek'; // Kod içi key (küçük harf)

                const aylik = yillik/12;

                const category = (r['Kategori'] || 'Tanımsız').trim(); 
                const material = (r['Malzeme Adı']||'').trim(); 
                
                // KATEGORİLERİ TOPLA
                if (category) categories.add(category);
                if (material) materialNames.add(material);


                return {
                    'Kategori': category, 
                    'Malzeme Adı': material,
                    'Mevcut Stok': stok,
                    'Birim Fiyat': birimFiyat, 
                    'Mevcut Stok Değeri': stok * birimFiyat, 
                    'Yıllık Tüketim': yillik,
                    
                    [ihaleAnahtar]: ihaleMiktari, 
                    'Ambara Teslim Edilecek Maliyeti': ihaleMiktari * birimFiyat, 
                    
                    'Kaç Ay Yeter': aylik ? stok / aylik : 0,
                    'İhale Sonrası Kaç Ay Yeter': aylik ? (stok + ihaleMiktari) / aylik : 0,
                    'Açıklama': (r['Açıklama']||'').trim()
                };
            }).filter(r=>r['Malzeme Adı']);
            
            // KATEGORİLERİ VE MALZEMELERİ BAŞLAT
            initializeCategorySettings(categories);
            populateMaterialFilter(materialNames); 

            applyFilters();
        }
        
        // KATEGORİ AYARLARI FONKSİYONU - TÜRKÇE SIRALAMA
        function initializeCategorySettings(categories) {
            const container = document.getElementById('categoryCheckboxes');
            let html = '';
            
            Array.from(categories).forEach(cat => {
                if (!(cat in categorySelection)) {
                    categorySelection[cat] = true; 
                }
            });

            // Türkçe alfabetik sıralama
            const sortedCategories = Array.from(categories).sort((a, b) => 
                a.localeCompare(b, 'tr', { sensitivity: 'base' })
            );

            sortedCategories.forEach(cat => {
                const isSelected = categorySelection[cat];
                const checked = isSelected ? 'checked' : '';
                const id = `cat-${cat.replace(/\s/g, '-')}`; 

                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="${id}"  
                               ${checked}
                               onchange="updateCategorySelection(this.checked, '${cat}')"  
                               class="h-4 w-4 text-custom-blue border-gray-300 rounded">
                        <label for="${id}" class="ml-2 text-sm text-gray-700">${cat}</label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function initializeMaterialMultiSelect() {
             materialTomSelect = new TomSelect('#materialMultiSelect', {
                plugins: ['remove_button', 'clear_button'],
                valueField: 'value',
                labelField: 'text',
                searchField: ['text'],
                placeholder: 'Malzeme adına göre seçin veya arayın...',
                onInitialize: function() {
                    this.on('change', applyFilters);
                }
             });
        }
        
        function populateMaterialFilter(materialNames) {
            if (!materialTomSelect) return;

            materialTomSelect.clear(true);
            materialTomSelect.clearOptions();
            
            // Malzeme listesini de Türkçe olarak sırala
            const sortedMaterialNames = Array.from(materialNames).sort((a, b) => 
                a.localeCompare(b, 'tr', { sensitivity: 'base' })
            );

            const options = sortedMaterialNames.map(name => ({
                value: name,
                text: name
            }));

            materialTomSelect.addOptions(options);
        }

        function updateThresholds() {
            const crit = parseFloat(document.getElementById('criticalThreshold').value);
            const warn = parseFloat(document.getElementById('warningThreshold').value);
            
            if (crit >= warn) {
                alert('Kritik Eşik (Ay) değeri, Uyarı Eşiği (Ay) değerinden küçük olmalıdır. Lütfen değerleri kontrol edin.');
                document.getElementById('criticalThreshold').value = criticalThreshold;  
                return;
            }

            criticalThreshold = crit;
            warningThreshold = warn;
            
            renderLegend();  
            applyFilters();  
        }
        
        function loadThresholds() {
            document.getElementById('criticalThreshold').value = criticalThreshold;
            document.getElementById('warningThreshold').value = warningThreshold;
        }

        function renderLegend() {
            const container = document.getElementById('legendContainer');
            
            const btnClass = 'py-1 px-3 rounded-lg border border-gray-300 hover:shadow-md transition duration-150';
            const activeClass = 'font-bold shadow-lg ring-2 ring-custom-blue';  

            const html = `
                <button onclick="setFilterAndApply('success')"  
                        class="${btnClass} bg-gray-100 hover:bg-gray-200 ${currentFilter === 'success' ? activeClass : ''}">
                    Stok Yeterli (> ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('warning')"  
                        class="${btnClass} bg-status-warning hover:bg-yellow-200 ${currentFilter === 'warning' ? activeClass : ''}">
                    Stok Azalıyor (${criticalThreshold} - ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('danger')"  
                        class="${btnClass} bg-status-danger hover:bg-red-300 ${currentFilter === 'danger' ? activeClass : ''}">
                    Kritik Seviye (< ${criticalThreshold} Ay)
                </button>
                
                <button onclick="setFilterAndApply('hepsi')"  
                        class="${btnClass} bg-blue-200 hover:bg-blue-400 border-blue-400 ${currentFilter === 'hepsi' ? activeClass : ''}">
                    Tüm Durumlar
                </button>
            `;
            container.innerHTML = html;
        }
        
        function initializeColumnSettings() {
            const container = document.getElementById('columnCheckboxes');
            let html = '';
            
            columnOrder.forEach(col => {
                const checked = columnVisibility[col.key] ? 'checked' : '';
                const disabled = (col.key === 'Malzeme Adı') ? 'disabled' : ''; 
                
                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="col-${col.key.replace(/\s/g, '-')}"  
                               data-column-key="${col.key}"  
                               ${checked} ${disabled}
                               onchange="updateColumnVisibility(this.checked, '${col.key}')"  
                               class="h-4 w-4 text-custom-blue border-gray-300 rounded">
                        <label for="col-${col.key.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 ${disabled ? 'opacity-50' : ''}">
                            ${col.label}
                        </label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function updateColumnVisibility(isVisible, key) {
             if (key === 'Malzeme Adı' && !isVisible) {
                document.getElementById(`col-${key.replace(/\s/g, '-')}`).checked = true;
                return;
             }
            columnVisibility[key] = isVisible;
            applyFilters();  
        }
        function toggleColumnSettings() {
            const dropdown = document.getElementById('columnDropdown');
            dropdown.classList.toggle('hidden');
        }

        // FİLTRELEME VE TABLO İŞLEMLERİ
        
        function clearMaterialFilter() {
            if (materialTomSelect) {
                materialTomSelect.clear();
            }
            applyFilters();  
        }

        function setFilterAndApply(filterValue) {
            currentFilter = filterValue;  
            renderLegend();  
            applyFilters();
        }

        function renderTable(rows) {
            const container = document.getElementById('tableContainer');
            if (!rows.length){
                container.innerHTML = '<p class="text-center text-gray-500">Gösterilecek veri bulunamadı.</p>';
                return;
            }

            const pageRows = rows;  

            let html = `<table class="min-w-full">
                <thead>
                    <tr>`;
            
            const visibleColumns = columnOrder.filter(col => columnVisibility[col.key]);
            
            visibleColumns.forEach((col, index) => {
                let cornerClass = '';
                if (index === 0) cornerClass = 'rounded-tl-2xl';
                if (index === visibleColumns.length - 1) cornerClass = 'rounded-tr-2xl';
                
                html += `
                    <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer ${cornerClass}"  
                        onclick="sortTable('${col.key}')">${col.label} ↕</th>
                `;
            });
            
            html += `</tr></thead><tbody>`;

            pageRows.forEach((r, index) => {
                
                let targetAy;
                if (rowColorBasis === 'mevcutStok') {
                    targetAy = r['Kaç Ay Yeter'];
                } else {
                    targetAy = r['İhale Sonrası Kaç Ay Yeter'];
                }
                
                let rowCls = 'status-success';
                if (targetAy < criticalThreshold) {
                    rowCls = 'status-danger';  
                } else if(targetAy < warningThreshold) {
                    rowCls = 'status-warning';
                }
                
                const isLastRow = index === pageRows.length - 1;  

                html += `<tr class="${rowCls}">`;
                
                visibleColumns.forEach((col, tdIndex) => {
                    // TD Sınıfı belirleme
                    let tdClass = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center';
                    
                    // Metin ve Kategori Sütunları
                    if (col.key === 'Malzeme Adı' || col.key === 'Açıklama' || col.key === 'Kategori') { 
                        tdClass = 'px-6 py-4 whitespace-normal text-sm text-gray-900 ' + (col.key === 'Malzeme Adı' || col.key === 'Kategori' ? 'text-left' : 'text-left');
                    }
                    
                    // Parasal Sütunları Sağa Hizalama
                    if (currencyKeys.includes(col.key)) {
                        tdClass = tdClass.replace('text-center', 'text-right');
                    } 

                    let cellValue = r[col.key];
                    
                    // Maliyet ve Birim Fiyatı formatla (₺ simgesi eklenir)
                    if (currencyKeys.includes(col.key)) {
                        cellValue = formatCurrency(r[col.key]); 
                    } 
                    else if (col.key.includes('Ay Yeter')) {
                        if (typeof cellValue === 'number' && !isNaN(cellValue)) {
                            cellValue = cellValue.toFixed(1).replace('.', ','); // Stok yeterliliğini 1 ondalık basamakla göster
                        }
                    } else if (typeof cellValue === 'number' && !isNaN(cellValue)) {
                        // Diğer sayıları formatla (Mevcut Stok, Yıllık Tüketim, Ambara teslim edilecek)
                        cellValue = formatNumber(cellValue); // Tam sayı olarak formatla (0 ondalık)
                    } else if (cellValue === null || cellValue === undefined) {
                        cellValue = '';
                    }

                    // YETERLİLİK SÜTUNLARI İÇİN ÖZEL RENK VE BOLD AYARLARI 
                    if (col.key === 'Kaç Ay Yeter' || col.key === 'İhale Sonrası Kaç Ay Yeter') {
                        const ayYeterlilik = r[col.key];
                        let textClass = 'text-gray-900';
                        
                        if (ayYeterlilik < criticalThreshold) {
                            textClass = 'font-bold text-red-600';
                        } else if (ayYeterlilik < warningThreshold) {
                            textClass = 'font-bold text-yellow-700';
                        } else {
                            textClass = 'font-bold text-green-600';
                        }
                        
                        tdClass += ' ' + textClass;
                    }  

                    if (isLastRow) {
                        if (tdIndex === 0) tdClass += ' rounded-bl-lg';
                        if (tdIndex === visibleColumns.length - 1) tdClass += ' rounded-br-lg';
                    }

                    html += `<td class="${tdClass}">${cellValue}</td>`;
                });

                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function sortTable(col){
            const asc = currentSort.column===col?!currentSort.asc:true;
            currentSort={column:col,asc};
            
            // Tablo sıralamasını da Türkçe yapacak şekilde güncelledim
            allRows.sort((a,b)=>{
                const valA=a[col]||'';
                const valB=b[col]||'';
                
                if (typeof valA === 'string' && typeof valB === 'string') {
                    // Türkçe string sıralaması
                    const comparison = valA.localeCompare(valB, 'tr', { sensitivity: 'base' });
                    return asc ? comparison : -comparison;
                } else {
                    // Sayısal sıralama (boş değerler 0 kabul edilir)
                    const numA = parseFloat(valA) || 0;
                    const numB = parseFloat(valB) || 0;
                    return asc ? numA - numB : numB - numA;
                }
            });

            applyFilters();
        }

        function applyFilters(){
            const selectedMaterials = materialTomSelect ? materialTomSelect.getValue() : [];
            const filter = currentFilter;  
            
            const selectedCategories = Object.keys(categorySelection).filter(key => categorySelection[key]);

            let filtered = allRows;
            
            // 1. Kategoriye göre filtreleme
            if (Object.keys(categorySelection).length > 0) {
                filtered = filtered.filter(r => selectedCategories.includes(r['Kategori']));
            }
            
            // 2. Malzeme Adına göre filtreleme (Çoklu Seçim)
            if (selectedMaterials.length > 0) {
                filtered = filtered.filter(r => selectedMaterials.includes(r['Malzeme Adı']));
            }

            // 3. Stok Yeterliliği durumuna göre filtreleme
            const filterBasis = (rowColorBasis === 'mevcutStok') ? 'Kaç Ay Yeter' : 'İhale Sonrası Kaç Ay Yeter';

            if(filter !== 'hepsi'){
                filtered = filtered.filter(r=>{
                    const ay=r[filterBasis];  
                    if(filter==='success') return ay>=warningThreshold;
                    if(filter==='warning') return ay>=criticalThreshold && ay<warningThreshold;
                    if(filter==='danger') return ay<criticalThreshold;
                });
            }
            
            renderTable(filtered);
            renderCurrentChart(filtered);  
            renderTenderChart(filtered);  

            // YENİ GRAFİKLERİ ÇAĞIR
            const costData = calculateCategoryCosts(filtered);
            renderCurrentCostChart(costData);
            renderTenderCostChart(costData);
        }

        function exportPDF(){ window.print(); }

        function formatDaysToMonths(totalDays) {
            if (totalDays < 0) return '0 Gün (Tükendi)';
            const daysPerMonth = 30;
            const months = Math.floor(totalDays / daysPerMonth);
            const remainingDays = Math.round(totalDays % daysPerMonth);
            
            let result = [];
            if (months > 0) result.push(months + ' Ay');
            if (remainingDays > 0 || months === 0) {
                result.push(remainingDays + ' Gün');
            }
            
            return result.join(' ');
        }
        
        // MALİYET HESAPLAMA FONKSİYONU
        function calculateCategoryCosts(rows) {
            const costs = {};
            let totalCurrentCost = 0;
            let totalTenderCost = 0;

            rows.forEach(r => {
                const category = r['Kategori'];
                const currentCost = r['Mevcut Stok Değeri'];
                const tenderCost = r['Ambara Teslim Edilecek Maliyeti'];

                if (!costs[category]) {
                    costs[category] = { current: 0, tender: 0 };
                }

                costs[category].current += currentCost;
                costs[category].tender += tenderCost;
                
                totalCurrentCost += currentCost;
                totalTenderCost += tenderCost;
            });

            return {
                labels: Object.keys(costs).sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' })),
                currentCosts: Object.values(costs).map(c => c.current),
                tenderCosts: Object.values(costs).map(c => c.tender),
                totalCurrentCost: totalCurrentCost,
                totalTenderCost: totalTenderCost
            };
        }

        // 1. STOK YETERLİLİĞİ ÇUBUK GRAFİKLERİ
        function renderCurrentChart(rows){
            const ctx=document.getElementById('chartCurrent').getContext('2d');
            const safeRows = [...rows];  
            
            const critical = safeRows.sort((a,b)=>a['Kaç Ay Yeter']-b['Kaç Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme Adı']);
            const values = critical.map(r=>r['Kaç Ay Yeter']*30);  

            if(chartCurrentInstance) chartCurrentInstance.destroy();
            
            chartCurrentInstance = new Chart(ctx,{
                type:'bar',
                data:{ labels, datasets:[{
                    label:'Kalan Stok (Ay/Gün)',  
                    data:values,  
                    backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']  
                }]},
                options:{
                    indexAxis:'y',  
                    responsive:true,  
                    maintainAspectRatio: false,  
                    
                    layout: {
                        padding: { left: 20, right: 80 }  
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki İlk 5 Malzeme (Mevcut Stok Yeterliliği)',  
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'  
                        },
                        datalabels:{  
                            anchor:'end',  
                            align:'right',  
                            formatter: value=>formatDaysToMonths(value)  
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTenderChart(rows){
            const ctx=document.getElementById('chartAfterTender').getContext('2d');
            const safeRows = [...rows];  
            
            const critical = safeRows.sort((a,b)=>a['İhale Sonrası Kaç Ay Yeter']-b['İhale Sonrası Kaç Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme Adı']);
            const values = critical.map(r=>r['İhale Sonrası Kaç Ay Yeter']*30);  

            if(chartTenderInstance) chartTenderInstance.destroy();
            
            chartTenderInstance = new Chart(ctx,{
                type:'bar',
                data:{  
                    labels,  
                    datasets:[{
                        label:'Kalan Stok (Ay/Gün)',  
                        data:values,  
                        backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']  
                    }]
                },
                options:{
                    indexAxis:'y',  
                    responsive:true,  
                    maintainAspectRatio: false,  
                    
                    layout: {
                        padding: { left: 20, right: 80 }  
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki İlk 5 Malzeme (Teslim Sonrası Yeterlilik)',  
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'  
                        },
                        datalabels:{  
                            anchor:'end',  
                            align:'right',  
                            formatter: value=>formatDaysToMonths(value)  
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }
        
        // 2. KATEGORİK MALİYET PASTA GRAFİKLERİ
        
        function renderCurrentCostChart(costData) {
            const ctx = document.getElementById('chartCurrentCost').getContext('2d');
            
            if (chartCurrentCostInstance) chartCurrentCostInstance.destroy();

            chartCurrentCostInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: costData.labels,
                    datasets: [{
                        label: 'Mevcut Stok Maliyeti',
                        data: costData.currentCosts,
                        backgroundColor: costData.labels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 15,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 20,
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: `Mevcut Stok Değeri Dağılımı (Toplam: ${formatCurrency(costData.totalCurrentCost)})`,
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'
                        },
                        datalabels: {
                            formatter: (value, context) => {
                                const total = costData.currentCosts.reduce((acc, cost) => acc + cost, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                
                                // Yüzde ve parasal değeri göster
                                if (percentage > 5) { // Sadece büyük dilimlerde etiketi göster
                                    return `${percentage}% (${formatCurrency(value).replace('₺', '')})`;
                                }
                                return '';
                            },
                            color: '#fff',
                            textShadow: '0 0 5px #000',
                            font: {
                                weight: 'bold',
                                size: 11
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTenderCostChart(costData) {
            const ctx = document.getElementById('chartTenderCost').getContext('2d');

            if (chartTenderCostInstance) chartTenderCostInstance.destroy();

            chartTenderCostInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: costData.labels,
                    datasets: [{
                        label: 'Ambara Teslim Edilecek Maliyeti',
                        data: costData.tenderCosts,
                        backgroundColor: costData.labels.map((_, i) => chartColors[i % chartColors.length]),
                        hoverOffset: 15,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 20,
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: `Ambara Teslim Edilecek Stok Maliyeti Dağılımı (Toplam: ${formatCurrency(costData.totalTenderCost)})`,
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'
                        },
                        datalabels: {
                            formatter: (value, context) => {
                                const total = costData.tenderCosts.reduce((acc, cost) => acc + cost, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                
                                // Yüzde ve parasal değeri göster
                                if (percentage > 5) { // Sadece büyük dilimlerde etiketi göster
                                    return `${percentage}% (${formatCurrency(value).replace('₺', '')})`;
                                }
                                return '';
                            },
                            color: '#fff',
                            textShadow: '0 0 5px #000',
                            font: {
                                weight: 'bold',
                                size: 11
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

    </script>
</body>
</html>

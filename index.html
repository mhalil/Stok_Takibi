<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stok Durumu</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #FFFFFF; color: #333; margin: 0; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: auto; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; }
    th { background: #2563eb; color: white; cursor: pointer; }
    td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    td.expandable { white-space: normal; word-wrap: break-word; max-width: 300px; }
    tr.warning { background-color: #fff8dc; }
    tr.danger { background-color: #fcdcdc; color: #000000;}
    tr.success { background-color: #FFFFFF; }
    .controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .legend { text-align: center; margin-top: 10px; }
    .legend span { margin: 0 10px; padding: 5px 10px; border-radius: 4px; color: #000; }
    .legend .success { background-color: #FFFFFF; } 
    .legend .warning { background-color: #fff8dc; }
    .legend .danger { background-color: #fcdcdc; color: #000000;}
    #chartContainer { margin-top: 40px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
    #tableContainer { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.1); overflow-x: auto; }
    button { background-color: #2563eb; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; }
    button:hover { background-color: #1e40af; }
    input[type="text"], select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    th.expandable, td.expandable { min-width: 200px; max-width: 400px; }
    .pagination { text-align: center; margin-top: 10px; }
    .pagination button { margin: 0 3px; }
  
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px; 
      table-layout: auto; 
      border: 1px solid #333; /* Ä°steÄŸe baÄŸlÄ±: Tablo dÄ±ÅŸ sÄ±nÄ±rÄ± */
    }
    
    th, td { 
      border: 1px solid #5599FF; /* BurasÄ±: SatÄ±r ve sÃ¼tun Ã§izgileri */
      padding: 8px; 
      text-align: center; 
      vertical-align: middle; 
    }
    
    /* Sayfalama butonlarÄ± stil */
    .pagination button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .pagination button:hover {
      background-color: #1e40af;
    }
    .pagination button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .pagination button.active {
      font-weight: bold;
      background-color: #1e40af;
    }
</style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body>
  <h1>ðŸ“Š ABONE Ä°ÅžLERÄ° DAÄ°RESÄ° BAÅžKANLIKLARI AMBAR STOK DURUMU</h1>
  <div class="controls">
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="loadCSV()">YÃ¼kle</button>
    <input type="text" id="searchInput" placeholder="Malzeme adÄ±na gÃ¶re ara..." onkeyup="applyFilters()">
    <button onclick="clearSearch()">Temizle</button>
    <select id="filterSelect" onchange="applyFilters()">
      <option value="hepsi">TÃ¼m Durumlar</option>
      <option value="success">Stok Yeterli</option>
      <option value="warning">Stok AzalÄ±yor</option>
      <option value="danger">Kritik Seviye</option>
    </select>
    <select id="rowsPerPage" onchange="applyFilters()">
      <option value="5">5 SatÄ±r / Sayfa</option>
      <option value="10" selected>10 SatÄ±r / Sayfa</option>
      <option value="20">20 SatÄ±r / Sayfa</option>
      <option value="50">50 SatÄ±r / Sayfa</option>
      <option value="0">TÃ¼mÃ¼</option>

    </select>
    <button onclick="exportPDF()">PDF Olarak DÄ±ÅŸa Aktar</button>
  </div>

  <div id="chartContainer">
    <canvas id="chart" height="34"></canvas>
  </div>

  <div class="legend">
    <span class="success">Stok Yeterli (&gt; 8 Ay)</span>
    <span class="warning">Stok AzalÄ±yor (6 - 8 Ay)</span>
    <span class="danger">Kritik Seviye (&lt; 6 Ay)</span>
  </div>

  <div id="tableContainer"></div>
  <div class="pagination" id="pagination"></div>

  <script>
    let allRows = [];
    let chartInstance = null;
    let currentSort = { column: null, asc: true };
    let currentPage = 1;

    function loadCSV() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      if (!file) { alert('LÃ¼tfen bir CSV dosyasÄ± seÃ§in.'); return; }
      const reader = new FileReader();
      reader.onload = e => parseCSV(e.target.result);
      reader.readAsText(file, 'UTF-8');
    }

    function parseCSV(csvText) {
      csvText = csvText.replace(/\uFEFF/g, '').trim();
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      allRows = parsed.data.map(r => {
        const yillik = parseFloat((r['YÄ±llÄ±k TÃ¼ketim']||'0').replace(',','.'));
        const stok = parseFloat((r['Mevcut Stok']||'0').replace(',','.'));
        const ihale = parseFloat((r['Ä°hale MiktarÄ±']||'0').replace(',','.'));
        const aylik = yillik/12;
        return {
          'Malzeme AdÄ±': (r['Malzeme AdÄ±']||'').trim(),
          'Mevcut Stok': stok,
          'YÄ±llÄ±k TÃ¼ketim': yillik,
          'Ä°hale MiktarÄ±': ihale,
          'KaÃ§ Ay Yeter': aylik? stok/aylik:0,
          'Ä°hale SonrasÄ± KaÃ§ Ay Yeter': aylik? (stok+ihale)/aylik:0,
          'AÃ§Ä±klama': (r['AÃ§Ä±klama']||'').trim()
        };
      }).filter(r=>r['Malzeme AdÄ±']);

      currentPage = 1;
      applyFilters();
    }

    function renderTable(rows) {
      const container = document.getElementById('tableContainer');
      if (!rows.length){
        container.innerHTML = '<p style="text-align:center;color:#666">HenÃ¼z veri yok.</p>';
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      // ---- SatÄ±r sayÄ±sÄ± kontrolÃ¼ ----
      let rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
      if (rowsPerPage === 0) rowsPerPage = rows.length; // 'TÃ¼mÃ¼' seÃ§eneÄŸi iÃ§in

      const totalPages = Math.ceil(rows.length / rowsPerPage);
      if(currentPage > totalPages) currentPage = totalPages; // mevcut sayfa toplam sayfayÄ± geÃ§mesin
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageRows = rows.slice(start, end);

      // ----- Tablo HTML oluÅŸturma -----
      let html = `<table><thead><tr>
        <th class="expandable" onclick="sortTable('Malzeme AdÄ±')">Malzeme AdÄ± â†•</th>
        <th onclick="sortTable('Mevcut Stok')">Mevcut Stok â†•</th>
        <th onclick="sortTable('YÄ±llÄ±k TÃ¼ketim')">YÄ±llÄ±k TÃ¼ketim â†•</th>
        <th onclick="sortTable('Ä°hale MiktarÄ±')">Ä°hale MiktarÄ± â†•</th>
        <th onclick="sortTable('KaÃ§ Ay Yeter')">KaÃ§ Ay Yeter â†•</th>
        <th onclick="sortTable('Ä°hale SonrasÄ± KaÃ§ Ay Yeter')">Ä°hale SonrasÄ± KaÃ§ Ay Yeter â†•</th>
        <th class="expandable">AÃ§Ä±klama</th>
      </tr></thead><tbody>`;

      pageRows.forEach(r => {
        let cls = 'success';
        if (r['Ä°hale SonrasÄ± KaÃ§ Ay Yeter'] < 6) cls = 'danger';
        else if(r['Ä°hale SonrasÄ± KaÃ§ Ay Yeter'] < 8) cls = 'warning';

        html += `<tr class="${cls}">
          <td class="expandable">${r['Malzeme AdÄ±']}</td>
          <td>${r['Mevcut Stok'].toLocaleString('tr-TR')}</td>
          <td>${r['YÄ±llÄ±k TÃ¼ketim'].toLocaleString('tr-TR')}</td>
          <td>${r['Ä°hale MiktarÄ±'].toLocaleString('tr-TR')}</td>
          <td>${r['KaÃ§ Ay Yeter'].toFixed(1).replace('.',',')}</td>
          <td>${r['Ä°hale SonrasÄ± KaÃ§ Ay Yeter'].toFixed(1).replace('.',',')}</td>
          <td class="expandable">${r['AÃ§Ä±klama']}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;

      // ---- TÃ¼mÃ¼ seÃ§ilmiÅŸse sayfalama gizle ----
      if (parseInt(document.getElementById('rowsPerPage').value) === 0) {
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      // ---- Sayfalama butonlarÄ± ----
      let paginationHtml = '';

      // Ä°lk ve Ã–nceki butonlarÄ±
      paginationHtml += `<button onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>Ä°lk</button>`;
      paginationHtml += `<button onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Ã–nceki</button>`;

      // Sayfa numaralarÄ±
      for (let i = 1; i <= totalPages; i++) {
        paginationHtml += `<button onclick="goPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
      }

      // Sonraki ve Son butonlarÄ±
      paginationHtml += `<button onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Sonraki</button>`;
      paginationHtml += `<button onclick="goPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Son</button>`;

      document.getElementById('pagination').innerHTML = '<div class="pagination">' + paginationHtml + '</div>';
    }


    function goPage(page){ 
      currentPage=page; 
      applyFilters(); 
    }

    function renderChart(rows){
      const ctx=document.getElementById('chart').getContext('2d');
      const critical = rows.sort((a,b)=>a['Ä°hale SonrasÄ± KaÃ§ Ay Yeter']-b['Ä°hale SonrasÄ± KaÃ§ Ay Yeter']).slice(0,5);
      const labels = critical.map(r=>r['Malzeme AdÄ±']);
      const values = critical.map(r=>r['Ä°hale SonrasÄ± KaÃ§ Ay Yeter']*30); // gÃ¼n olarak
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{label:'Kalan Stok (GÃ¼n)', data:values, backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']}]},
        options:{
          indexAxis:'y', responsive:true, plugins:{
            legend:{display:false},
            datalabels:{ anchor:'end', align:'right', formatter: value=>Math.round(value)+' gÃ¼n' }
          },
          scales:{x:{beginAtZero:true}}
        },
        plugins: [ChartDataLabels]
      });
    }

    function sortTable(col){
      const asc = currentSort.column===col?!currentSort.asc:true;
      currentSort={column:col,asc};
      allRows.sort((a,b)=>{
        const valA=a[col]||0,valB=b[col]||0;
        return typeof valA==='string'? (asc? valA.localeCompare(valB): valB.localeCompare(valA)) : (asc? valA-valB: valB-valA);
      });
      applyFilters();
    }

    function applyFilters(){
      const search=document.getElementById('searchInput').value.toLowerCase();
      const filter=document.getElementById('filterSelect').value;
      let filtered=allRows.filter(r=>r['Malzeme AdÄ±'].toLowerCase().includes(search));
      if(filter!=='hepsi'){
        filtered=filtered.filter(r=>{
          const ay=r['Ä°hale SonrasÄ± KaÃ§ Ay Yeter'];
          if(filter==='success') return ay>=8;
          if(filter==='warning') return ay>6 && ay<8;
          if(filter==='danger') return ay<=6;
        });
      }
      renderTable(filtered);
      renderChart(filtered);
    }

    function clearSearch() {
        // Arama kutusunu temizle
        document.getElementById('searchInput').value = ''; 
        
        // Filtreleri tekrar uygula (bu, temizlenmiÅŸ arama kutusuyla tabloyu gÃ¼nceller)
        applyFilters(); 
    }

    function exportPDF(){ window.print(); }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Malzeme Stok Durumu</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#2563eb',
                        'custom-darkblue': '#1e40af',
                        'status-warning': '#fff8dc', 
                        'status-danger': '#f8d7da',  
                        'zebra-strip': '#f3f4f6',    
                    }
                }
            }
        }
    </script>

    <style>
        /* Grafik ta≈üƒ±yƒ±cƒ±larƒ±na sabit y√ºkseklik verilir */
        #chartCurrentContainer, #chartAfterTenderContainer {
            height: 350px;  
        }

        /* Tablo geni≈üliklerini ve kaydƒ±rma √ßubuƒüunu y√∂netmek i√ßin */
        .table-responsive {
            overflow-x: auto;
        }
        
        /* Tablo stil */
        #tableContainer table {
            border-collapse: separate;
            border-spacing: 0 0.4rem; /* Dikey bo≈üluk */
        }
        
        /* Renklendirme kurallarƒ± */
        tbody tr:nth-child(odd) {
            background-color: #f3f4f6 !important;  
        }
        #tableContainer tr.status-warning { background-color: #fff8dc !important; }  
        #tableContainer tr.status-danger { background-color: #f8d7da !important; }  
        
        /* Yazdƒ±rma ayarlarƒ± */
        @media print {
            .mb-6 { margin-bottom: 0 !important; }  
            #chartsContainer { padding: 0 !important; }
            .controls, .legend, #settingsCanvas, .ts-control {  /* ts-control Tom Select aray√ºz√º */
                display: none !important; 
            }
            h1 { margin-top: 0; }
            #tableContainer { box-shadow: none; padding: 0; }
        }

        /* S√ºtun ve Kategori Ayarlarƒ± Men√ºs√º ƒ∞√ßin √ñzel CSS */
        .dropdown-menu {
            z-index: 10;
        }

        /* Tom Select i√ßin √∂zel stil ayarlamalarƒ± (Tailwind'e uyum) */
        .ts-control {
            @apply p-2 border border-gray-300 rounded-lg shadow-sm w-full md:min-w-[300px] bg-white;
        }
        .ts-wrapper.multi .ts-control > div {
            @apply bg-custom-blue text-white rounded-md text-sm py-1 px-2;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body class="font-sans bg-gray-100 p-5">
    <h1 class="text-3xl font-bold text-center mb-1 text-gray-800">üìä ABONE ƒ∞≈ûLERƒ∞ DAƒ∞RESƒ∞ BA≈ûKANLIKLARI AMBAR STOK DURUMU üó†</h1>
    
    <input type="text" id="reportInfo" 
            placeholder="Rapor tarihini, versiyonunu veya ek notlarƒ± buraya girin..." 
            class="block w-3/4 mx-auto text-center border-b border-gray-400 focus:outline-none focus:border-custom-blue p-1 mb-6 
                         text-lg font-bold text-gray-900 bg-transparent"
            value="">
    
    <div class="flex flex-wrap justify-center items-center gap-4 mb-6 p-4 bg-white rounded-2xl shadow-md controls">
        <input type="file" id="csvFile" accept=".csv" class="p-2 border border-gray-300 rounded-lg">
        <button onclick="loadCSV()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Y√ºkle</button>
        
        <div class="flex flex-col gap-2 w-full md:w-auto md:min-w-[300px]">
             <label for="materialMultiSelect" class="text-sm font-medium text-gray-700 hidden md:block">Malzemeye G√∂re √áoklu Filtre:</label>
             <select id="materialMultiSelect" multiple class="w-full"></select>
        </div>
        
        <button onclick="clearMaterialFilter()" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Malzeme Filtresini Temizle</button>
        
        <button onclick="exportPDF()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">PDF Olarak Dƒ±≈üa Aktar</button>
    </div>

    <div id="settingsCanvas" class="mb-6 p-4 bg-white rounded-2xl shadow-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">‚öôÔ∏è Rapor Ayarlarƒ±</h3>
        
        <div class="flex flex-wrap justify-around items-start gap-6">
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[250px]">
                <p class="font-semibold text-gray-700 mb-2">Kritik Stok E≈üikleri (Ay)</p>
                <div class="flex gap-4">
                    <div class="flex items-center gap-1">
                        <label for="criticalThreshold" class="text-sm font-medium text-gray-700">Kritik (<):</label>
                        <input type="number" id="criticalThreshold" value="6" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-red-300 rounded text-center text-sm">
                    </div>
                    <div class="flex items-center gap-1">
                        <label for="warningThreshold" class="text-sm font-medium text-gray-700">Uyarƒ± (<):</label>
                        <input type="number" id="warningThreshold" value="8" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-yellow-300 rounded text-center text-sm">
                    </div>
                </div>
            </div>
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[350px]">
                <label class="font-semibold text-gray-700 block mb-2">Satƒ±r Renklendirme √ñl√ß√ºt√º:</label>
                <div class="flex items-center gap-4">
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisAfterTender" name="rowColorBasis" value="ihaleSonrasi" 
                               onchange="setRowColorBasis(this.value)" checked 
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisAfterTender" class="ml-1 text-sm text-gray-700">ƒ∞hale Sonrasƒ± Durum</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisCurrent" name="rowColorBasis" value="mevcutStok" 
                               onchange="setRowColorBasis(this.value)"
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisCurrent" class="ml-1 text-sm text-gray-700">Mevcut Stok Durumu</label>
                    </div>
                </div>
            </div>

            <div class="relative inline-block text-left border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[200px]">
                <button onclick="toggleCategorySettings()" class="w-full bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    ‚ò∞ Kategori Filtrelerini Y√∂net
                </button>

                <div id="categoryDropdown" class="dropdown-menu origin-top-right absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2 max-h-64 overflow-y-auto">
                    <p class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">G√∂sterilecek Kategorileri Se√ßin:</p>
                    
                    <div class="flex justify-between mb-2">
                        <a href="#" onclick="toggleAllCategories(true); return false;" class="text-xs text-custom-blue hover:text-custom-darkblue font-semibold">T√ºm√ºn√º Se√ß</a>
                        <a href="#" onclick="toggleAllCategories(false); return false;" class="text-xs text-red-500 hover:text-red-700 font-semibold">T√ºm√ºn√º Kaldƒ±r</a>
                    </div>
                    <div id="categoryCheckboxes" class="space-y-1">
                        </div>
                </div>
            </div>
            
            <div class="relative inline-block text-left border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[200px]">
                <button onclick="toggleColumnSettings()" class="w-full bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    ‚úì S√ºtun Ayarlarƒ±nƒ± G√∂ster/Gizle
                </button>

                <div id="columnDropdown" class="dropdown-menu origin-top-right absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2">
                    <p class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">G√∂sterilecek S√ºtunlarƒ± Se√ßin:</p>
                    
                    <div class="flex justify-between mb-2">
                        <a href="#" onclick="toggleAllColumns(true); return false;" class="text-xs text-custom-blue hover:text-custom-darkblue font-semibold">T√ºm√ºn√º Se√ß</a>
                        <a href="#" onclick="toggleAllColumns(false); return false;" class="text-xs text-red-500 hover:text-red-700 font-semibold">T√ºm√ºn√º Kaldƒ±r</a>
                    </div>
                    <div id="columnCheckboxes" class="space-y-1">
                        </div>
                </div>
            </div>

        </div>
    </div>
    
    <div class="mb-6">
        <div id="chartsContainer" class="flex gap-4">
            <div id="chartCurrentContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartCurrent"></canvas>
            </div>
            <div id="chartAfterTenderContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartAfterTender"></canvas>
            </div>
        </div>
    </div>

    <div class="text-center mb-4 legend flex justify-center gap-4" id="legendContainer"></div>

    <div id="tableContainer" class="bg-white p-4 rounded-2xl shadow-md table-responsive overflow-hidden"></div>
    
    <script>
        let allRows = [];
        let chartCurrentInstance = null;
        let chartTenderInstance = null;
        let currentSort = { column: null, asc: true };
        let rowColorBasis = 'ihaleSonrasi';  
        let currentFilter = 'hepsi';  
        let materialTomSelect = null; 
        
        let categorySelection = {}; 

        // E≈üik Deƒüerleri
        let criticalThreshold = 6;  
        let warningThreshold = 8;  
        
        // S√ºtun g√∂r√ºn√ºrl√ºƒü√º durumu
        let columnVisibility = {
            'Kategori': true, 
            'Malzeme Adƒ±': true,
            'Mevcut Stok': true,
            'Yƒ±llƒ±k T√ºketim': true,
            'ƒ∞hale Miktarƒ±': true,
            'Ka√ß Ay Yeter': true,
            'ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter': true,
            'A√ßƒ±klama': true
        };

        // S√ºtunlarƒ±n g√∂sterim sƒ±rasƒ± ve ba≈ülƒ±klarƒ±
        const columnOrder = [
            { key: 'Kategori', label: 'Malzeme Kategorisi' }, 
            { key: 'Malzeme Adƒ±', label: 'Malzeme Adƒ±' },
            { key: 'Mevcut Stok', label: 'Mevcut Stok' },
            { key: 'Yƒ±llƒ±k T√ºketim', label: 'Yƒ±llƒ±k T√ºketim' },
            { key: 'ƒ∞hale Miktarƒ±', label: 'Ambara Teslim Edilecek Miktar' },
            { key: 'Ka√ß Ay Yeter', label: 'Mevcut Stok Ka√ß Ay Yeter' },
            { key: 'ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter', label: 'Teslim Sonrasƒ± Stok Ka√ß Ay Yeter' },
            { key: 'A√ßƒ±klama', label: 'A√ßƒ±klama' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadThresholds();  
            initializeColumnSettings();
            renderLegend();  
            
            initializeMaterialMultiSelect();

            applyFilters();  
        });

        // YENƒ∞ FONKSƒ∞YON: T√ºm kategorilerin se√ßim durumunu deƒüi≈ütirir
        function toggleAllCategories(shouldSelect) {
            const checkboxes = document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                const categoryKey = checkbox.id.substring(4).replace(/-/g, ' '); // id'den kategori adƒ±nƒ± geri √ßƒ±kar
                
                // Checkbox'ƒ±n durumunu ayarla
                checkbox.checked = shouldSelect;
                
                // categorySelection nesnesini g√ºncelle
                categorySelection[categoryKey] = shouldSelect;
            });

            applyFilters();
        }

        // YENƒ∞ FONKSƒ∞YON: T√ºm s√ºtunlarƒ±n g√∂r√ºn√ºrl√ºk durumunu deƒüi≈ütirir
        function toggleAllColumns(shouldSelect) {
            // Malzeme Adƒ± s√ºtunu sabit kalmalƒ±dƒ±r
            const nonFixedColumns = columnOrder.filter(col => col.key !== 'Malzeme Adƒ±'); 

            nonFixedColumns.forEach(col => {
                const checkbox = document.getElementById(`col-${col.key.replace(/\s/g, '-')}`);
                
                if (checkbox) {
                    // Checkbox'ƒ±n durumunu ayarla
                    checkbox.checked = shouldSelect;
                    
                    // columnVisibility nesnesini g√ºncelle
                    columnVisibility[col.key] = shouldSelect;
                }
            });

             // Malzeme Adƒ±'nƒ± her zaman g√∂r√ºn√ºr tut
            columnVisibility['Malzeme Adƒ±'] = true; 
            
            applyFilters();
        }

        // Kategori Ayarlarƒ± Butonu ve A√ßƒ±lƒ±r Men√º Kontrol√º
        function toggleCategorySettings() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Kategori Se√ßimi G√ºncelleme
        function updateCategorySelection(isSelected, categoryKey) {
            categorySelection[categoryKey] = isSelected;
            applyFilters();
        }

        function setRowColorBasis(basis) {
            rowColorBasis = basis;
            applyFilters();
        }

        // CSV Y√úKLEME VE ZAMAN KAYDI
        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) { alert('L√ºtfen bir CSV dosyasƒ± se√ßin.'); return; }
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(file, 'UTF-8');
            
            const now = new Date();
            const dateString = now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR');
            const reportInfo = document.getElementById('reportInfo');
            reportInfo.value = dateString;  
        }

        function parseCSV(csvText) {
            csvText = csvText.replace(/\uFEFF/g, '').trim();
            const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
            
            const categories = new Set(); 
            const materialNames = new Set(); 

            allRows = parsed.data.map(r => {
                const yillik = parseFloat((r['Yƒ±llƒ±k T√ºketim']||'0').replace(',','.'));
                const stok = parseFloat((r['Mevcut Stok']||'0').replace(',','.'));
                const ihale = parseFloat((r['ƒ∞hale Miktarƒ±']||'0').replace(',','.'));
                const aylik = yillik/12;

                const category = (r['Kategori'] || 'Tanƒ±msƒ±z').trim(); 
                const material = (r['Malzeme Adƒ±']||'').trim(); 

                categories.add(category); 
                if (material) materialNames.add(material); 

                return {
                    'Kategori': category, 
                    'Malzeme Adƒ±': material,
                    'Mevcut Stok': stok,
                    'Yƒ±llƒ±k T√ºketim': yillik,
                    'ƒ∞hale Miktarƒ±': ihale,
                    'Ka√ß Ay Yeter': aylik? stok/aylik:0,
                    'ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter': aylik? (stok+ihale)/aylik:0,
                    'A√ßƒ±klama': (r['A√ßƒ±klama']||'').trim()
                };
            }).filter(r=>r['Malzeme Adƒ±']);
            
            initializeCategorySettings(categories);
            populateMaterialFilter(materialNames); 

            applyFilters();
        }
        
        // Kategori filtreleme se√ßeneklerini checkbox olarak doldurur
        function initializeCategorySettings(categories) {
            const container = document.getElementById('categoryCheckboxes');
            let html = '';
            
            // Yeni kategoriler i√ßin varsayƒ±lan olarak se√ßili ayarla
            Array.from(categories).forEach(cat => {
                if (!(cat in categorySelection)) {
                    categorySelection[cat] = true; // Varsayƒ±lan olarak t√ºm kategoriler se√ßili gelsin
                }
            });

            // Checkbox'larƒ± olu≈ütur
            const sortedCategories = Array.from(categories).sort();
            sortedCategories.forEach(cat => {
                const isSelected = categorySelection[cat];
                const checked = isSelected ? 'checked' : '';
                // ID olu≈üturulurken bo≈üluklar tire ile deƒüi≈ütirilir, filtrelemede geri alƒ±nƒ±r.
                const id = `cat-${cat.replace(/\s/g, '-')}`; 

                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="${id}"  
                               ${checked}
                               onchange="updateCategorySelection(this.checked, '${cat}')"  
                               class="h-4 w-4 text-custom-blue border-gray-300 rounded">
                        <label for="${id}" class="ml-2 text-sm text-gray-700">${cat}</label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Malzeme Tom Select'i ba≈ülatƒ±r
        function initializeMaterialMultiSelect() {
             materialTomSelect = new TomSelect('#materialMultiSelect', {
                plugins: ['remove_button', 'clear_button'],
                valueField: 'value',
                labelField: 'text',
                searchField: ['text'],
                placeholder: 'Malzeme adƒ±na g√∂re se√ßin veya arayƒ±n...',
                onInitialize: function() {
                    this.on('change', applyFilters);
                }
             });
        }
        
        // Malzeme filtreleme se√ßeneklerini doldurur
        function populateMaterialFilter(materialNames) {
            if (!materialTomSelect) return;

            materialTomSelect.clear(true);
            materialTomSelect.clearOptions();

            const options = Array.from(materialNames).sort().map(name => ({
                value: name,
                text: name
            }));

            materialTomSelect.addOptions(options);
        }

        // E≈ûƒ∞K AYARLARI (Deƒüi≈ümedi)
        function updateThresholds() {
            const crit = parseFloat(document.getElementById('criticalThreshold').value);
            const warn = parseFloat(document.getElementById('warningThreshold').value);
            
            if (crit >= warn) {
                alert('Kritik E≈üik (Ay) deƒüeri, Uyarƒ± E≈üiƒüi (Ay) deƒüerinden k√º√ß√ºk olmalƒ±dƒ±r. L√ºtfen deƒüerleri kontrol edin.');
                document.getElementById('criticalThreshold').value = criticalThreshold;  
                return;
            }

            criticalThreshold = crit;
            warningThreshold = warn;
            
            renderLegend();  
            applyFilters();  
        }
        
        function loadThresholds() {
            document.getElementById('criticalThreshold').value = criticalThreshold;
            document.getElementById('warningThreshold').value = warningThreshold;
        }

        function renderLegend() {
            const container = document.getElementById('legendContainer');
            
            const btnClass = 'py-1 px-3 rounded-lg border border-gray-300 hover:shadow-md transition duration-150';
            const activeClass = 'font-bold shadow-lg ring-2 ring-custom-blue';  

            const html = `
                <button onclick="setFilterAndApply('success')"  
                        class="${btnClass} bg-gray-100 hover:bg-gray-200 ${currentFilter === 'success' ? activeClass : ''}">
                    Stok Yeterli (> ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('warning')"  
                        class="${btnClass} bg-status-warning hover:bg-yellow-200 ${currentFilter === 'warning' ? activeClass : ''}">
                    Stok Azalƒ±yor (${criticalThreshold} - ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('danger')"  
                        class="${btnClass} bg-status-danger hover:bg-red-300 ${currentFilter === 'danger' ? activeClass : ''}">
                    Kritik Seviye (< ${criticalThreshold} Ay)
                </button>
                
                <button onclick="setFilterAndApply('hepsi')"  
                        class="${btnClass} bg-blue-200 hover:bg-blue-400 border-blue-400 ${currentFilter === 'hepsi' ? activeClass : ''}">
                    T√ºm Durumlar
                </button>
            `;
            container.innerHTML = html;
        }
        
        // S√úTUN Gƒ∞ZLEME AYARLARI
        function initializeColumnSettings() {
            const container = document.getElementById('columnCheckboxes');
            let html = '';
            
            columnOrder.forEach(col => {
                const checked = columnVisibility[col.key] ? 'checked' : '';
                const disabled = (col.key === 'Malzeme Adƒ±') ? 'disabled' : ''; 
                
                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="col-${col.key.replace(/\s/g, '-')}"  
                               data-column-key="${col.key}"  
                               ${checked} ${disabled}
                               onchange="updateColumnVisibility(this.checked, '${col.key}')"  
                               class="h-4 w-4 text-custom-blue border-gray-300 rounded">
                        <label for="col-${col.key.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 ${disabled ? 'opacity-50' : ''}">
                            ${col.label}
                        </label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function updateColumnVisibility(isVisible, key) {
             if (key === 'Malzeme Adƒ±' && !isVisible) {
                document.getElementById(`col-${key.replace(/\s/g, '-')}`).checked = true;
                return;
             }
            columnVisibility[key] = isVisible;
            applyFilters();  
        }
        function toggleColumnSettings() {
            const dropdown = document.getElementById('columnDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Fƒ∞LTRELEME VE TABLO ƒ∞≈ûLEMLERƒ∞
        
        function clearMaterialFilter() {
            if (materialTomSelect) {
                materialTomSelect.clear();
            }
            applyFilters();  
        }

        function setFilterAndApply(filterValue) {
            currentFilter = filterValue;  
            renderLegend();  
            applyFilters();
        }

        function renderTable(rows) {
            const container = document.getElementById('tableContainer');
            if (!rows.length){
                container.innerHTML = '<p class="text-center text-gray-500">G√∂sterilecek veri bulunamadƒ±.</p>';
                return;
            }

            const pageRows = rows;  

            let html = `<table class="min-w-full">
                <thead>
                    <tr>`;
            
            const visibleColumns = columnOrder.filter(col => columnVisibility[col.key]);
            
            visibleColumns.forEach((col, index) => {
                let cornerClass = '';
                if (index === 0) cornerClass = 'rounded-tl-2xl';
                if (index === visibleColumns.length - 1) cornerClass = 'rounded-tr-2xl';
                
                let labelText = col.label;

                if (col.key === 'ƒ∞hale Miktarƒ±') labelText = 'Ambara Teslim Edilecek Miktar';
                if (col.key === 'Ka√ß Ay Yeter') labelText = 'Mevcut Stok Ka√ß Ay Yeter';
                if (col.key === 'ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter') labelText = 'Teslim Sonrasƒ± Stok Ka√ß Ay Yeter';
                
                html += `
                    <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer ${cornerClass}"  
                        onclick="sortTable('${col.key}')">${labelText} ‚Üï</th>
                `;
            });
            
            html += `</tr></thead><tbody>`;

            pageRows.forEach((r, index) => {
                
                let targetAy;
                if (rowColorBasis === 'mevcutStok') {
                    targetAy = r['Ka√ß Ay Yeter'];
                } else {
                    targetAy = r['ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter'];
                }
                
                let rowCls = 'status-success';
                if (targetAy < criticalThreshold) {
                    rowCls = 'status-danger';  
                } else if(targetAy < warningThreshold) {
                    rowCls = 'status-warning';
                }
                
                const isLastRow = index === pageRows.length - 1;  

                html += `<tr class="${rowCls}">`;
                
                visibleColumns.forEach((col, tdIndex) => {
                    let tdClass = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center';
                    
                    if (col.key === 'Malzeme Adƒ±' || col.key === 'A√ßƒ±klama' || col.key === 'Kategori') { 
                        tdClass = 'px-6 py-4 whitespace-normal text-sm text-gray-900 ' + (col.key === 'Malzeme Adƒ±' || col.key === 'Kategori' ? 'text-left' : 'text-left');
                    }
                    
                    let cellValue = r[col.key];
                    if (typeof cellValue === 'number' && !isNaN(cellValue)) {
                          if (col.key.includes('Ay Yeter')) {
                            cellValue = cellValue.toFixed(1).replace('.', ',');
                        } else {
                            cellValue = cellValue.toLocaleString('tr-TR');
                        }
                    } else if (cellValue === null || cellValue === undefined) {
                        cellValue = '';
                    }


                    if (col.key === 'Ka√ß Ay Yeter' || col.key === 'ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter') {
                        const ayYeterlilik = r[col.key];
                        let textClass = 'text-gray-900';
                        
                        if (ayYeterlilik < criticalThreshold) {
                            textClass = 'font-bold text-red-600';
                        } else if (ayYeterlilik < warningThreshold) {
                            textClass = 'font-bold text-yellow-700';
                        } else {
                            textClass = 'font-bold text-green-600';
                        }
                        
                        tdClass += ' ' + textClass;
                    }  

                    if (isLastRow) {
                        if (tdIndex === 0) tdClass += ' rounded-bl-lg';
                        if (tdIndex === visibleColumns.length - 1) tdClass += ' rounded-br-lg';
                    }

                    html += `<td class="${tdClass}">${cellValue}</td>`;
                });

                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function sortTable(col){
            const asc = currentSort.column===col?!currentSort.asc:true;
            currentSort={column:col,asc};
            allRows.sort((a,b)=>{
                const valA=a[col]||0,valB=b[col]||0;
                return typeof valA==='string'? (asc? valA.localeCompare(valB): valB.localeCompare(a[col])) : (asc? valA-valB: valB-a[col]);
            });
            applyFilters();
        }

        function applyFilters(){
            const selectedMaterials = materialTomSelect ? materialTomSelect.getValue() : [];
            const filter = currentFilter;  
            
            // Se√ßili kategorileri al (Sadece 'true' olanlar)
            const selectedCategories = Object.keys(categorySelection).filter(key => categorySelection[key]);

            let filtered = allRows;
            
            // 1. Kategoriye g√∂re filtreleme
            if (Object.keys(categorySelection).length > 0) {
                 // Eƒüer hi√ß kategori se√ßilmemi≈üse bile (selectedCategories.length === 0), 
                 // bu blok √ßalƒ±≈üƒ±r ve filtered bo≈ü kalƒ±r.
                filtered = filtered.filter(r => selectedCategories.includes(r['Kategori']));
            }
            
            // 2. Malzeme Adƒ±na g√∂re filtreleme (√áoklu Se√ßim)
            if (selectedMaterials.length > 0) {
                filtered = filtered.filter(r => selectedMaterials.includes(r['Malzeme Adƒ±']));
            }

            // 3. Stok Yeterliliƒüi durumuna g√∂re filtreleme
            const filterBasis = (rowColorBasis === 'mevcutStok') ? 'Ka√ß Ay Yeter' : 'ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter';

            if(filter !== 'hepsi'){
                filtered = filtered.filter(r=>{
                    const ay=r[filterBasis];  
                    if(filter==='success') return ay>=warningThreshold;
                    if(filter==='warning') return ay>=criticalThreshold && ay<warningThreshold;
                    if(filter==='danger') return ay<criticalThreshold;
                });
            }
            
            renderTable(filtered);
            renderCurrentChart(filtered);  
            renderTenderChart(filtered);  
        }

        function exportPDF(){ window.print(); }

        // GRAFƒ∞K VE FORMATLAMA (Deƒüi≈ümedi)

        function formatDaysToMonths(totalDays) {
            if (totalDays < 0) return '0 G√ºn (T√ºkendi)';
            const daysPerMonth = 30;
            const months = Math.floor(totalDays / daysPerMonth);
            const remainingDays = Math.round(totalDays % daysPerMonth);
            
            let result = [];
            if (months > 0) result.push(months + ' Ay');
            if (remainingDays > 0 || months === 0) {
                result.push(remainingDays + ' G√ºn');
            }
            
            return result.join(' ');
        }


        function renderCurrentChart(rows){
            const ctx=document.getElementById('chartCurrent').getContext('2d');
            const safeRows = [...rows];  
            
            const critical = safeRows.sort((a,b)=>a['Ka√ß Ay Yeter']-b['Ka√ß Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme Adƒ±']);
            const values = critical.map(r=>r['Ka√ß Ay Yeter']*30);  

            if(chartCurrentInstance) chartCurrentInstance.destroy();
            
            chartCurrentInstance = new Chart(ctx,{
                type:'bar',
                data:{ labels, datasets:[{
                    label:'Kalan Stok (Ay/G√ºn)',  
                    data:values,  
                    backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']  
                }]},
                options:{
                    indexAxis:'y',  
                    responsive:true,  
                    maintainAspectRatio: false,  
                    
                    layout: {
                        padding: { left: 20, right: 80 }  
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki ƒ∞lk 5 Malzeme (Mevcut Stok Yeterliliƒüi)',  
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'  
                        },
                        datalabels:{  
                            anchor:'end',  
                            align:'right',  
                            formatter: value=>formatDaysToMonths(value)  
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTenderChart(rows){
            const ctx=document.getElementById('chartAfterTender').getContext('2d');
            const safeRows = [...rows];  
            
            const critical = safeRows.sort((a,b)=>a['ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter']-b['ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme Adƒ±']);
            const values = critical.map(r=>r['ƒ∞hale Sonrasƒ± Ka√ß Ay Yeter']*30);  

            if(chartTenderInstance) chartTenderInstance.destroy();
            
            chartTenderInstance = new Chart(ctx,{
                type:'bar',
                data:{  
                    labels,  
                    datasets:[{
                        label:'Kalan Stok (Ay/G√ºn)',  
                        data:values,  
                        backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6']  
                    }]
                },
                options:{
                    indexAxis:'y',  
                    responsive:true,  
                    maintainAspectRatio: false,  
                    
                    layout: {
                        padding: { left: 20, right: 80 }  
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki ƒ∞lk 5 Malzeme (Teslim Sonrasƒ± Yeterlilik)',  
                            font: { size: 16, weight: 'bold' },
                            color: '#333333'  
                        },
                        datalabels:{  
                            anchor:'end',  
                            align:'right',  
                            formatter: value=>formatDaysToMonths(value)  
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }

    </script>
</body>
</html>

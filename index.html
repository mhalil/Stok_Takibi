<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Malzeme Stok Durumu</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#2563eb',
                        'custom-darkblue': '#1e40af',
                        'status-warning': '#fff8dc', // Mevcut uyarı rengi
                        'status-danger': '#f8d7da',  // Mevcut kritik renk
                        'zebra-strip': '#f3f4f6',    // Zebra Şerit rengi
                    }
                }
            }
        }
    </script>

    <style>
        /* Grafik taşıyıcılarına sabit yükseklik verilir */
        #chartCurrentContainer, #chartAfterTenderContainer {
            height: 350px; 
        }

        /* Tablo genişliklerini ve kaydırma çubuğunu yönetmek için */
        .table-responsive {
            overflow-x: auto;
        }
        
        /* Tüm çizgileri kaldır ve satır aralarına boşluk bırak */
        #tableContainer table {
            border-collapse: separate;
            border-spacing: 0 0.4rem; /* Dikey boşluk */
        }
        
        /* ---------------------------------------------------------------- */
        /* RENKLENDİRME KURALLARI */
        /* ---------------------------------------------------------------- */

        /* Özel Zebra Şerit kuralı (tek numaralı satırlara) */
        tbody tr:nth-child(odd) {
            background-color: #f3f4f6 !important; 
        }
        
        /* Kritik Durum kuralları */
        #tableContainer tr.status-warning { background-color: #fff8dc !important; } 
        #tableContainer tr.status-danger { background-color: #f8d7da !important; } 
        
        /* YAZDIRMA (PDF) AYARLARI */
        @media print {
            .mb-6 { margin-bottom: 0 !important; } 
            #chartsContainer { padding: 0 !important; }
            .controls, .legend, #settingsCanvas { 
                display: none !important; /* Kontrol elemanları, efsane ve ayarlar gizlenir. */
            }
            h1 { margin-top: 0; }
            #tableContainer { box-shadow: none; padding: 0; }
        }

        /* Sütun Ayarları Menüsü İçin Özel CSS */
        .dropdown-menu {
            z-index: 10;
        }
        
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body class="font-sans bg-gray-100 p-5">
    <h1 class="text-3xl font-bold text-center mb-1 text-gray-800">📊 ABONE İŞLERİ DAİRESİ BAŞKANLIKLARI AMBAR STOK DURUMU 🗠</h1>
    
    <input type="text" id="reportInfo" 
            placeholder="Rapor tarihini, versiyonunu veya ek notları buraya girin..." 
            class="block w-3/4 mx-auto text-center border-b border-gray-400 focus:outline-none focus:border-custom-blue p-1 mb-6 
                        text-lg font-bold text-gray-900 bg-transparent"
            value="">
    
    <div class="flex flex-wrap justify-center items-center gap-4 mb-6 p-4 bg-white rounded-2xl shadow-md controls">
        <input type="file" id="csvFile" accept=".csv" class="p-2 border border-gray-300 rounded-lg">
        <button onclick="loadCSV()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Yükle</button>
        
        <div class="flex gap-2">
            <input type="text" id="searchInput" placeholder="Malzeme adına göre ara..." onkeyup="applyFilters()" class="p-2 border border-gray-300 rounded-lg">
            <button onclick="clearSearch()" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded-lg shadow-md transition duration-150">Temizle</button>
        </div>
        
        <button onclick="exportPDF()" class="bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150">PDF Olarak Dışa Aktar</button>
    </div>

    <div id="settingsCanvas" class="mb-6 p-4 bg-white rounded-2xl shadow-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">⚙️ Rapor Ayarları</h3>
        
        <div class="flex flex-wrap justify-around items-start gap-6">
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[250px]">
                <p class="font-semibold text-gray-700 mb-2">Kritik Stok Eşikleri (Ay)</p>
                <div class="flex gap-4">
                    <div class="flex items-center gap-1">
                        <label for="criticalThreshold" class="text-sm font-medium text-gray-700">Kritik (<):</label>
                        <input type="number" id="criticalThreshold" value="6" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-red-300 rounded text-center text-sm">
                    </div>
                    <div class="flex items-center gap-1">
                        <label for="warningThreshold" class="text-sm font-medium text-gray-700">Uyarı (<):</label>
                        <input type="number" id="warningThreshold" value="8" min="1" onchange="updateThresholds()" class="w-12 p-1 border border-yellow-300 rounded text-center text-sm">
                    </div>
                </div>
            </div>
            
            <div class="border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[350px]">
                <label class="font-semibold text-gray-700 block mb-2">Satır Renklendirme Ölçütü:</label>
                <div class="flex items-center gap-4">
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisAfterTender" name="rowColorBasis" value="ihaleSonrasi" 
                               onchange="setRowColorBasis(this.value)" checked 
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisAfterTender" class="ml-1 text-sm text-gray-700">İhale Sonrası Durum</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="colorBasisCurrent" name="rowColorBasis" value="mevcutStok" 
                               onchange="setRowColorBasis(this.value)"
                               class="h-4 w-4 text-custom-blue border-gray-300 focus:ring-custom-blue">
                        <label for="colorBasisCurrent" class="ml-1 text-sm text-gray-700">Mevcut Stok Durumu</label>
                    </div>
                </div>
            </div>

            <div class="relative inline-block text-left border border-gray-300 rounded-2xl p-3 bg-gray-50 flex-1 min-w-[200px]">
                <button onclick="toggleColumnSettings()" class="w-full bg-custom-blue hover:bg-custom-darkblue text-white py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    ✓ Sütun Ayarlarını Göster/Gizle
                </button>

                <div id="columnDropdown" class="dropdown-menu origin-top-right absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden p-2">
                    <p class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Gösterilecek Sütunları Seçin:</p>
                    <div id="columnCheckboxes" class="space-y-1">
                        </div>
                </div>
            </div>

        </div>
    </div>
    
    <div class="mb-6">
        <div id="chartsContainer" class="flex gap-4">
            <div id="chartCurrentContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartCurrent"></canvas>
            </div>
            <div id="chartAfterTenderContainer" class="bg-white p-4 rounded-2xl shadow-md flex-1">
                <canvas id="chartAfterTender"></canvas>
            </div>
        </div>
    </div>

    <div class="text-center mb-4 legend flex justify-center gap-4" id="legendContainer"></div>

    <div id="tableContainer" class="bg-white p-4 rounded-2xl shadow-md table-responsive overflow-hidden"></div>
    
    <script>
        let allRows = [];
        let chartCurrentInstance = null;
        let chartTenderInstance = null;
        let currentSort = { column: null, asc: true };
        let rowColorBasis = 'ihaleSonrasi'; 
        let currentFilter = 'hepsi'; 

        // Eşik Değerleri
        let criticalThreshold = 6; 
        let warningThreshold = 8; 
        
        // Sütun görünürlüğü durumu
        let columnVisibility = {
            'Malzeme Adı': true,
            'Mevcut Stok': true,
            'Yıllık Tüketim': true,
            'İhale Miktarı': true,
            'Kaç Ay Yeter': true,
            'İhale Sonrası Kaç Ay Yeter': true,
            'Açıklama': true
        };

        const columnOrder = [
            { key: 'Malzeme Adı', label: 'Malzeme Adı' },
            { key: 'Mevcut Stok', label: 'Mevcut Stok' },
            { key: 'Yıllık Tüketim', label: 'Yıllık Tüketim' },
            { key: 'İhale Miktarı', label: 'Ambara Teslim Edilecek Miktar' },
            { key: 'Kaç Ay Yeter', label: 'Mevcut Stok Kaç Ay Yeter' },
            { key: 'İhale Sonrası Kaç Ay Yeter', label: 'Teslim Sonrası Stok Kaç Ay Yeter' },
            { key: 'Açıklama', label: 'Açıklama' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
             loadThresholds(); 
             initializeColumnSettings();
             renderLegend(); 
             // Yükleme sırasında filtremeyi tetikler
             applyFilters(); 
        });

        function setRowColorBasis(basis) {
            rowColorBasis = basis;
            applyFilters();
        }

        // CSV YÜKLEME VE ZAMAN KAYDI
        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) { alert('Lütfen bir CSV dosyası seçin.'); return; }
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(file, 'UTF-8');
            
            const now = new Date();
            const dateString = now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR');
            const reportInfo = document.getElementById('reportInfo');
            reportInfo.value = dateString; 
        }

        function parseCSV(csvText) {
            csvText = csvText.replace(/\uFEFF/g, '').trim();
            const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
            allRows = parsed.data.map(r => {
                const yillik = parseFloat((r['Yıllık Tüketim']||'0').replace(',','.'));
                const stok = parseFloat((r['Mevcut Stok']||'0').replace(',','.'));
                const ihale = parseFloat((r['İhale Miktarı']||'0').replace(',','.'));
                const aylik = yillik/12;
                return {
                    'Malzeme Adı': (r['Malzeme Adı']||'').trim(),
                    'Mevcut Stok': stok,
                    'Yıllık Tüketim': yillik,
                    'İhale Miktarı': ihale,
                    'Kaç Ay Yeter': aylik? stok/aylik:0,
                    'İhale Sonrası Kaç Ay Yeter': aylik? (stok+ihale)/aylik:0,
                    'Açıklama': (r['Açıklama']||'').trim()
                };
            }).filter(r=>r['Malzeme Adı']);

            applyFilters();
        }

        // EŞİK AYARLARI
        function updateThresholds() {
            const crit = parseFloat(document.getElementById('criticalThreshold').value);
            const warn = parseFloat(document.getElementById('warningThreshold').value);
            
            if (crit >= warn) {
                alert('Kritik Eşik (Ay) değeri, Uyarı Eşiği (Ay) değerinden küçük olmalıdır. Lütfen değerleri kontrol edin.');
                document.getElementById('criticalThreshold').value = criticalThreshold; 
                return;
            }

            criticalThreshold = crit;
            warningThreshold = warn;
            
            renderLegend(); 
            applyFilters(); 
        }
        
        function loadThresholds() {
            document.getElementById('criticalThreshold').value = criticalThreshold;
            document.getElementById('warningThreshold').value = warningThreshold;
        }

        function renderLegend() {
            const container = document.getElementById('legendContainer');
            
            const btnClass = 'py-1 px-3 rounded-lg border border-gray-300 hover:shadow-md transition duration-150';
            const activeClass = 'font-bold shadow-lg ring-2 ring-custom-blue'; 

            const html = `
                <button onclick="setFilterAndApply('success')" 
                        class="${btnClass} bg-gray-100 hover:bg-gray-200 ${currentFilter === 'success' ? activeClass : ''}">
                    Stok Yeterli (> ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('warning')" 
                        class="${btnClass} bg-status-warning hover:bg-yellow-200 ${currentFilter === 'warning' ? activeClass : ''}">
                    Stok Azalıyor (${criticalThreshold} - ${warningThreshold} Ay)
                </button>

                <button onclick="setFilterAndApply('danger')" 
                        class="${btnClass} bg-status-danger hover:bg-red-300 ${currentFilter === 'danger' ? activeClass : ''}">
                    Kritik Seviye (< ${criticalThreshold} Ay)
                </button>
                
                <button onclick="setFilterAndApply('hepsi')" 
                        class="${btnClass} bg-blue-200 hover:bg-blue-400 border-blue-400 ${currentFilter === 'hepsi' ? activeClass : ''}">
                    Tüm Durumlar
                </button>
            `;
            container.innerHTML = html;
        }
        
        // SÜTUN GİZLEME AYARLARI
        function initializeColumnSettings() {
            const container = document.getElementById('columnCheckboxes');
            let html = '';
            
            columnOrder.forEach(col => {
                const checked = columnVisibility[col.key] ? 'checked' : '';
                const disabled = (col.key === 'Malzeme Adı') ? 'disabled' : ''; 
                
                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="col-${col.key.replace(/\s/g, '-')}" 
                               data-column-key="${col.key}" 
                               ${checked} ${disabled}
                               onchange="updateColumnVisibility(this.checked, '${col.key}')" 
                               class="h-4 w-4 text-custom-blue border-gray-300 rounded">
                        <label for="col-${col.key.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 ${disabled ? 'opacity-50' : ''}">
                            ${col.label}
                        </label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function updateColumnVisibility(isVisible, key) {
            if (key === 'Malzeme Adı' && !isVisible) {
                 document.getElementById(`col-${key.replace(/\s/g, '-')}`).checked = true;
                 return;
            }
            columnVisibility[key] = isVisible;
            applyFilters(); 
        }
        function toggleColumnSettings() {
            const dropdown = document.getElementById('columnDropdown');
            dropdown.classList.toggle('hidden');
        }

        // FİLTRELEME VE TABLO İŞLEMLERİ
        function clearSearch() {
            document.getElementById('searchInput').value = ''; 
            applyFilters(); 
        }
        
        function setFilterAndApply(filterValue) {
            currentFilter = filterValue; 
            renderLegend(); 
            applyFilters();
        }

        function renderTable(rows) {
            const container = document.getElementById('tableContainer');
            if (!rows.length){
                container.innerHTML = '<p class="text-center text-gray-500">Gösterilecek veri bulunamadı.</p>';
                return;
            }

            const pageRows = rows; 

            // Tablo HTML oluşturma - BAŞLIKLAR (TH)
            let html = `<table class="min-w-full">
                <thead>
                    <tr>`;
            
            const visibleColumns = columnOrder.filter(col => columnVisibility[col.key]);
            
            visibleColumns.forEach((col, index) => {
                let cornerClass = '';
                if (index === 0) cornerClass = 'rounded-tl-2xl';
                if (index === visibleColumns.length - 1) cornerClass = 'rounded-tr-2xl';
                
                let labelText = col.label;

                if (col.key === 'İhale Miktarı') labelText = 'Ambara Teslim Edilecek Miktar';
                if (col.key === 'Kaç Ay Yeter') labelText = 'Mevcut Stok Kaç Ay Yeter';
                if (col.key === 'İhale Sonrası Kaç Ay Yeter') labelText = 'Teslim Sonrası Stok Kaç Ay Yeter';
                
                html += `
                    <th class="px-6 py-3 bg-custom-blue text-center text-sm font-bold text-white uppercase tracking-wider cursor-pointer ${cornerClass}" 
                        onclick="sortTable('${col.key}')">${labelText} ↕</th>
                `;
            });
            
            html += `</tr></thead><tbody>`;

            // Tablo HTML oluşturma - SATIRLAR (TD)
            pageRows.forEach((r, index) => {
                
                // SATIR RENKLENDİRME MANTIĞI 
                let targetAy;
                if (rowColorBasis === 'mevcutStok') {
                    targetAy = r['Kaç Ay Yeter'];
                } else {
                    targetAy = r['İhale Sonrası Kaç Ay Yeter'];
                }
                
                let rowCls = 'status-success';
                if (targetAy < criticalThreshold) {
                    rowCls = 'status-danger'; 
                } else if(targetAy < warningThreshold) {
                    rowCls = 'status-warning';
                }
                
                const isLastRow = index === pageRows.length - 1; 

                html += `<tr class="${rowCls}">`;
                
                // Hücreleri görünürlük ayarına göre oluştur
                visibleColumns.forEach((col, tdIndex) => {
                    let tdClass = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center';
                    
                    if (col.key === 'Malzeme Adı' || col.key === 'Açıklama') {
                        tdClass = 'px-6 py-4 whitespace-normal text-sm text-gray-900 ' + (col.key === 'Malzeme Adı' ? 'text-left' : 'text-left');
                    }
                    
                    // Hücrenin Değerini Al ve Formatla
                    let cellValue = r[col.key];
                    if (typeof cellValue === 'number' && !isNaN(cellValue)) {
                         if (col.key.includes('Ay Yeter')) {
                            cellValue = cellValue.toFixed(1).replace('.', ',');
                        } else {
                            cellValue = cellValue.toLocaleString('tr-TR');
                        }
                    } else if (cellValue === null || cellValue === undefined) {
                        cellValue = '';
                    }


                    // YETERLİLİK SÜTUNLARI İÇİN ÖZEL RENK VE BOLD AYARLARI
                    if (col.key === 'Kaç Ay Yeter' || col.key === 'İhale Sonrası Kaç Ay Yeter') {
                        const ayYeterlilik = r[col.key];
                        let textClass = 'text-gray-900';
                        
                        if (ayYeterlilik < criticalThreshold) {
                            textClass = 'font-bold text-red-600';
                        } else if (ayYeterlilik < warningThreshold) {
                            textClass = 'font-bold text-yellow-700';
                        } else {
                            textClass = 'font-bold text-green-600';
                        }
                        
                        tdClass += ' ' + textClass;
                    } 

                    if (isLastRow) {
                        if (tdIndex === 0) tdClass += ' rounded-bl-lg';
                        if (tdIndex === visibleColumns.length - 1) tdClass += ' rounded-br-lg';
                    }

                    html += `<td class="${tdClass}">${cellValue}</td>`;
                });

                html += `</tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function sortTable(col){
            const asc = currentSort.column===col?!currentSort.asc:true;
            currentSort={column:col,asc};
            allRows.sort((a,b)=>{
                const valA=a[col]||0,valB=b[col]||0;
                return typeof valA==='string'? (asc? valA.localeCompare(valB): valB.localeCompare(a[col])) : (asc? valA-valB: valB-a[col]);
            });
            applyFilters();
        }

        function applyFilters(){
            const search=document.getElementById('searchInput').value.toLowerCase();
            const filter=currentFilter; 
            
            let filtered=allRows.filter(r=>r['Malzeme Adı'].toLowerCase().includes(search));
            
            const filterBasis = (rowColorBasis === 'mevcutStok') ? 'Kaç Ay Yeter' : 'İhale Sonrası Kaç Ay Yeter';

            if(filter!=='hepsi'){
                filtered=filtered.filter(r=>{
                    const ay=r[filterBasis]; 
                    if(filter==='success') return ay>=warningThreshold;
                    if(filter==='warning') return ay>=criticalThreshold && ay<warningThreshold;
                    if(filter==='danger') return ay<criticalThreshold;
                });
            }
            
            renderTable(filtered);
            renderCurrentChart(filtered); 
            renderTenderChart(filtered); 
        }

        function exportPDF(){ window.print(); }

        // GRAFİK VE FORMATLAMA
        function formatDaysToMonths(totalDays) {
            if (totalDays < 0) return '0 Gün (Tükendi)';
            const daysPerMonth = 30;
            const months = Math.floor(totalDays / daysPerMonth);
            const remainingDays = Math.round(totalDays % daysPerMonth);
            
            let result = [];
            if (months > 0) result.push(months + ' Ay');
            if (remainingDays > 0 || months === 0) {
                result.push(remainingDays + ' Gün');
            }
            
            return result.join(' ');
        }


        function renderCurrentChart(rows){
            const ctx=document.getElementById('chartCurrent').getContext('2d');
            const safeRows = [...rows]; 
            
            const critical = safeRows.sort((a,b)=>a['Kaç Ay Yeter']-b['Kaç Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme Adı']);
            const values = critical.map(r=>r['Kaç Ay Yeter']*30); 

            if(chartCurrentInstance) chartCurrentInstance.destroy();
            
            chartCurrentInstance = new Chart(ctx,{
                type:'bar',
                data:{ labels, datasets:[{
                    label:'Kalan Stok (Ay/Gün)', 
                    data:values, 
                    backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6'] 
                }]},
                options:{
                    indexAxis:'y', 
                    responsive:true, 
                    maintainAspectRatio: false, 
                    
                    layout: {
                        padding: { left: 20, right: 80 } 
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki İlk 5 Malzeme (Mevcut Stok Yeterliliği)', 
                            font: { size: 16, weight: 'bold' },
                            color: '#333333' 
                        },
                        datalabels:{ 
                            anchor:'end', 
                            align:'right', 
                            formatter: value=>formatDaysToMonths(value) 
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTenderChart(rows){
            const ctx=document.getElementById('chartAfterTender').getContext('2d');
            const safeRows = [...rows]; 
            
            const critical = safeRows.sort((a,b)=>a['İhale Sonrası Kaç Ay Yeter']-b['İhale Sonrası Kaç Ay Yeter']).slice(0,5);
            const labels = critical.map(r=>r['Malzeme Adı']);
            const values = critical.map(r=>r['İhale Sonrası Kaç Ay Yeter']*30); 

            if(chartTenderInstance) chartTenderInstance.destroy();
            
            chartTenderInstance = new Chart(ctx,{
                type:'bar',
                data:{ 
                    labels, 
                    datasets:[{
                        label:'Kalan Stok (Ay/Gün)', 
                        data:values, 
                        backgroundColor:['#ef4444','#f97316','#facc15','#22c55e','#3b82f6'] 
                    }]
                },
                options:{
                    indexAxis:'y', 
                    responsive:true, 
                    maintainAspectRatio: false, 
                    
                    layout: {
                        padding: { left: 20, right: 80 } 
                    },
                    
                    plugins:{
                        legend:{display:false},
                        title: {
                            display: true,
                            text: 'Kritik Seviyedeki İlk 5 Malzeme (Teslim Sonrası Yeterlilik)', 
                            font: { size: 16, weight: 'bold' },
                            color: '#333333' 
                        },
                        datalabels:{ 
                            anchor:'end', 
                            align:'right', 
                            formatter: value=>formatDaysToMonths(value) 
                        }
                    },
                    scales:{x:{beginAtZero:true}}
                },
                plugins: [ChartDataLabels]
            });
        }

    </script>
</body>
</html>
